"use strict";define(["angular","snap","common","jQuery","angularMaterial","angularCookie","angularUIRouter","angularLoad"],function(angular,Snap){angular.module("rop.services",["ngMaterial","ngMessages","ngCookies","ui.router","oc.lazyLoad"]).config(["$ocLazyLoadProvider",function($ocLazyLoadProvider){$ocLazyLoadProvider.config({jsLoader:requirejs,debug:!1})}]).factory("ScopeInitializer",["$rootScope","$q","$mdMedia","$cookies","$window","$state","$http","$mdDialog","$mdUtil","$timeout",function($rootScope,$q,$mdMedia,$cookies,$window,$state,$http,$mdDialog,$mdUtil,$timeout){var obj={},_lang=$cookies.get("_lang"),alertDialog=function(msg){return $mdDialog.show($mdDialog.alert().parent(angular.element(obj.contextSelector?document.querySelector(obj.contextSelector):document.body)).clickOutsideToClose(!0).textContent(msg).ariaLabel(msg).ok("zh-cn"==_lang?"了解":"Got it"))},confirmDialog=function(msg,accept,reject){var confirm=$mdDialog.confirm().parent(angular.element(obj.contextSelector?document.querySelector(obj.contextSelector):document.body)).textContent(msg).ariaLabel("确认框").clickOutsideToClose(!0).ok("zh-cn"==_lang?"确定":"Yes").cancel("zh-cn"==_lang?"取消":"No");return $mdDialog.show(confirm).then(function(){if(accept&&"function"==typeof accept)return accept.call()},function(){if(reject&&"function"==typeof reject)return reject.call()})},toPlatform=function(path){$window.location.href=Constant.protocol+"://"+Constant.host+":"+Constant.port+"/"+(path?path.replace(/^\/(.*)/,"$1"):"")},getSystemHints=function(){$http.post("/agent",{module:"common",partial:"common",api:"tips"}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?$rootScope.systemHints=body.data.data_list:$rootScope.alert(body.data.msg)},function(why){$rootScope.alert(why)})},LoginController=function($scope,$mdDialog){$scope.login_msg="",$scope.loginMistakes=$cookies.get("_showCaptcha")?3:0;var captcha_img="/captcha?l=50&_l=1",rememberMistakes=function(){if($scope.loginMistakes++,$scope.loginMistakes>2){var today=new Date;$cookies.put("_showCaptcha",!0,{path:"/",domain:""+(Constant.nosubdomain?"":".")+Constant.host,expires:new Date(today.getFullYear(),today.getMonth(),today.getDate()+1)})}},forgetMistakes=function(){$cookies.put("_showCaptcha","",{path:"/",domain:""+(Constant.nosubdomain?"":".")+Constant.host}),$cookies.remove("_showCaptcha",{path:"/",domain:""+(Constant.nosubdomain?"":".")+Constant.host})};$scope.captcha_img=captcha_img+"&time="+(new Date).getTime(),$scope.clearMsg=function(){$scope.login_msg=""},$scope.login=function(){if($scope.loginForm.$invalid)return $scope.loginForm.$error.required&&$scope.loginForm.$error.required.forEach(function(r){r.$setDirty(!0)}),$("#loginPanel").addClass("invalid"),$timeout(function(){$("#loginPanel").removeClass("invalid"),$scope.login_msg="zh-cn"==$rootScope._lang?"请检查输入项是否正确":"Please verify the inputs"},600),void rememberMistakes.call();var OSName="Unknown OS";navigator.appVersion.indexOf("Win")!=-1&&(OSName="Windows"),navigator.appVersion.indexOf("Mac")!=-1&&(OSName="MacOS"),navigator.appVersion.indexOf("X11")!=-1&&(OSName="UNIX"),navigator.appVersion.indexOf("Linux")!=-1&&(OSName="Linux");var myParam={user_account:$scope.user_account?$scope.user_account.trim():"",password:$scope.password?$scope.password.trim():"",login_system:OSName};$http.post("/agent",{module:"sso",partial:"session",api:"login",param:myParam}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?($rootScope.profile=body.data,$cookies.put("_session",JSON.stringify(body.data),{path:"/",domain:""+(Constant.nosubdomain?"":".")+Constant.host}),forgetMistakes.call(),getSystemHints.call(),$mdDialog.hide(),$(".login").css("pointerEvents","")):(rememberMistakes.call(),$("#loginPanel").addClass("invalid"),$timeout(function(){$("#loginPanel").removeClass("invalid"),$scope.login_msg=body.data.msg},600))},function(why){$scope.login_msg=why})},$scope.resetCaptcha=function(){$scope.captchaCode="",$scope.captcha_img=captcha_img+"&time="+(new Date).getTime()},$scope.clearMsg=function(){$scope.login_msg=""},$scope.verifyCode=function(){var _captcha=$cookies.get("_captcha");return _captcha?$scope.captchaCode&&$scope.captchaCode.toLowerCase()==$cookies.get("_captcha").toLowerCase():void $scope.resetCaptcha()},$scope.close=function(){$mdDialog.hide(),$(".login").css("pointerEvents","")},$scope.toPlatform=$rootScope.toPlatform},loadingTriangles=[[{x:5.26166667,y:26.99955},{x:9.46644444,y:34.20105},{x:13.6788148,y:26.99955}],[{x:10.5233333,y:34.7985},{x:18.9344074,y:34.7985},{x:14.7281111,y:27.597}],[{x:15.7795333,y:26.99955},{x:19.9903852,y:34.20105},{x:24.195163,y:26.99955}],[{x:21.0384667,y:34.7985},{x:29.4556148,y:34.7985},{x:25.2523556,y:27.597}],[{x:26.3001333,y:26.99955},{x:30.5064296,y:34.20105},{x:34.7172815,y:26.99955}],[{x:31.5618,y:18.00045},{x:35.7680963,y:25.20195},{x:39.9789481,y:18.00045}],[{x:31.5618,y:16.79895},{x:39.9789481,y:16.79895},{x:35.7680963,y:9.59745}],[{x:30.507037,y:16.2015},{x:34.7178889,y:9},{x:26.3007407,y:9}],[{x:34.7178889,y:7.7985},{x:30.507037,y:.597},{x:26.3007407,y:7.7985}],[{x:21.0384667,y:-45e-5},{x:25.2523556,y:7.20105},{x:29.4556148,y:-45e-5}],[{x:10.5233333,y:-45e-5},{x:14.7281111,y:7.20105},{x:18.9344074,y:-45e-5}],[{x:9.46644444,y:.597},{x:5.26166667,y:7.7985},{x:13.6788148,y:7.7985}],[{x:13.6788148,y:9},{x:5.26166667,y:9},{x:9.46644444,y:16.2015}],[{x:0,y:16.79895},{x:8.41714815,y:16.79895},{x:4.2062963,y:9.59745}],[{x:0,y:18.00045},{x:4.2062963,y:25.20195},{x:8.41714815,y:18.00045}],[{x:19.9897778,y:7.2015},{x:11.0107778,y:22.5675},{x:28.9687778,y:22.5675}]],pathList=(document.querySelectorAll(".loading svg.triangle circle"),document.querySelectorAll(".loading svg.triangle path")),preloadingDefer=$q.defer(),loadingDefer=$q.defer();return Snap.animate(0,300,function(val){for(var i=0;i<pathList.length;i++){var r=pathList[i];val<=100?angular.element(r).attr({d:"M"+loadingTriangles[i][0].x+","+loadingTriangles[i][0].y+" L"+(loadingTriangles[i][0].x+(loadingTriangles[i][1].x-loadingTriangles[i][0].x)*Math.min(val,100)/100)+","+(loadingTriangles[i][0].y+(loadingTriangles[i][1].y-loadingTriangles[i][0].y)*(Math.min(val,100)/100))}):val<=200?angular.element(r).attr({d:"M"+loadingTriangles[i][0].x+","+loadingTriangles[i][0].y+" L"+loadingTriangles[i][1].x+","+loadingTriangles[i][1].y+" L"+(loadingTriangles[i][1].x+(loadingTriangles[i][2].x-loadingTriangles[i][1].x)*(val-100)/100)+","+(loadingTriangles[i][1].y+(loadingTriangles[i][2].y-loadingTriangles[i][1].y)*((val-100)/100))}):val<300?angular.element(r).attr({d:"M"+loadingTriangles[i][0].x+","+loadingTriangles[i][0].y+" L"+loadingTriangles[i][1].x+","+loadingTriangles[i][1].y+" L"+loadingTriangles[i][2].x+","+loadingTriangles[i][2].y+" L"+(loadingTriangles[i][2].x+(loadingTriangles[i][0].x-loadingTriangles[i][2].x)*(val-200)/100)+","+(loadingTriangles[i][2].y+(loadingTriangles[i][0].y-loadingTriangles[i][2].y)*((val-200)/100))}):300==val&&angular.element(r).attr({d:"M"+loadingTriangles[i][0].x+","+loadingTriangles[i][0].y+" L"+loadingTriangles[i][1].x+","+loadingTriangles[i][1].y+" L"+loadingTriangles[i][2].x+","+loadingTriangles[i][2].y+" L"+loadingTriangles[i][0].x+","+loadingTriangles[i][0].y+"Z"})}},ROPStyleConstant.preLoadingTime,function(){preloadingDefer.resolve()}),angular.element($window).bind("unload",function(){document.querySelector(".loading").style.display="",$(".loading").fadeIn()}),angular.extend(obj,{removeLoading:function(){if(!angular.element(".loading").hasClass("out"))return $(".loading").addClass("start"),preloadingDefer.promise.then(function(){Snap.animate(0,100,function(val){for(var i=0;i<pathList.length;i++){var r=pathList[i];i+1<pathList.length?angular.element(r).css({fill:"rgba(0,197,163,"+val/100+")"}):angular.element(r).css({fill:"rgba(255,255,255,"+val/100+")"})}},ROPStyleConstant.loadingTime,function(){loadingDefer.resolve(),$(".loading").fadeOut(300,function(){$(".loading").addClass("out")})})}),loadingDefer.promise},preloadingPromise:preloadingDefer.promise,loadingPromise:loadingDefer.promise,minify:function(){return!$mdMedia("(min-width: 1400px)")},_lang:_lang,locate:function(url){$window.location.href=url},openPopup:function(path){$window.open(Constant.protocol+"://"+Constant.host+":"+Constant.port+"/"+(path?path:""),"_blank")},toPlatform:toPlatform,go:function(tab,params,option){$state.go(tab,params,option)},reload:function(){$state.reload()},logout:function(success,fail){var self=this;return $http.post("/agent",{module:"sso",partial:"session",api:"logout"}).then(function(body){if("boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success){if($cookies.put("_session",null,{path:"/",domain:""+(Constant.nosubdomain?"":".")+Constant.host}),$cookies.remove("_session",{path:"/",domain:""+(Constant.nosubdomain?"":".")+Constant.host}),success&&"function"==typeof success){var result=success.call();return result&&result.then&&"function"==typeof result.then?result.then():$q.when()}}else if(fail&&"function"==typeof fail){var _result=fail.call(body.msg);return _result&&_result.then&&"function"==typeof _result.then?_result.then():$q.reject()}return $q.reject()},function(why){return self.alert(why),$q.reject()})},quitSession:function(from){var self=this;return $http.post("/agent",{module:"sso",partial:"session",api:"quit"}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?($cookies.put("_session",null,{path:"/",domain:""+(Constant.nosubdomain?"":".")+Constant.host}),$cookies.remove("_session",{path:"/",domain:""+(Constant.nosubdomain?"":".")+Constant.host}),toPlatform("sso"+(from?"?from="+from:""))):self.alert(body.msg)},function(why){self.alert(why)})},alert:alertDialog,confirm:confirmDialog,ajax:function(api,_param,_cb,_fail){if(api){var callback=void 0,param=_param,fail=void 0,self=this;return"function"==typeof _cb?(param=_param,callback=_cb,fail=_fail):"function"==typeof _param&&(callback=_param,fail=_cb),!self._module&&(self._module=document.querySelector("meta[name=module]").content),$http.post("/agent",{module:self._module,partial:$rootScope.tab,api:api,param:param}).then(function(body){if("boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success){if(callback&&"function"==typeof callback){var q=callback.call(null,body.data);if(q)return q}return body.data}return self.alert(body.data.msg),$q.reject(body.data.msg)},function(why){return self.alert(why),fail&&"function"==typeof fail&&fail.call(),$q.reject(why)})}},browserType:window.getBrowserType(),OSName:window.getOSName(),nextTick:function(){$mdUtil.nextTick.apply(null,arguments)},defer:function(){return $q.defer()},apiRedirect:function(api){return Constant.legacyDomain+"/api/redirect?api_name="+api},showLogin:function(ev){return $(".login").css("pointerEvents","auto"),$mdDialog.show({controller:LoginController,templateUrl:"/_view/common/login",parent:angular.element(".login"),clickOutsideToClose:!1,targetEvent:ev,openFrom:ev.target}).then(function(answer){},function(){$(".login").css("pointerEvents","")})},snap:Snap})}]).factory("ROPDateUtil",function(){var getFirstDateOfMonth=function(date){return new Date(date.getFullYear(),date.getMonth(),1)},getMonthsInSeason=function(date){var months=[],monthIndex=date.getMonth();return monthIndex>=0&&monthIndex<=2?months=[0,1,2]:monthIndex>=3&&monthIndex<=5?months=[3,4,5]:monthIndex>=6&&monthIndex<=8?months=[6,7,8]:monthIndex>=9&&monthIndex<=11&&(months=[9,10,11]),months},getNumberOfDaysInMonth=function(date){return new Date(date.getFullYear(),date.getMonth()+1,0).getDate()},getDateInNextMonth=function(date){return new Date(date.getFullYear(),date.getMonth()+1,1)},getDateInPreviousMonth=function(date){return new Date(date.getFullYear(),date.getMonth()-1,1)},isSameMonthAndYear=function(d1,d2){return d1.getFullYear()===d2.getFullYear()&&d1.getMonth()===d2.getMonth()},isSameDay=function(d1,d2){return d1.getDate()==d2.getDate()&&isSameMonthAndYear(d1,d2)},isInNextMonth=function(startDate,endDate){var nextMonth=getDateInNextMonth(startDate);return isSameMonthAndYear(nextMonth,endDate)},isInPreviousMonth=function(startDate,endDate){var previousMonth=getDateInPreviousMonth(startDate);return isSameMonthAndYear(endDate,previousMonth)},getDateMidpoint=function(d1,d2){return createDateAtMidnight((d1.getTime()+d2.getTime())/2)},getWeekOfMonth=function(date){var firstDayOfMonth=getFirstDateOfMonth(date);return Math.floor((firstDayOfMonth.getDay()+date.getDate()-1)/7)},incrementDays=function(date,numberOfDays){return new Date(date.getFullYear(),date.getMonth(),date.getDate()+numberOfDays)},incrementMonths=function(date,numberOfMonths){var dateInTargetMonth=new Date(date.getFullYear(),date.getMonth()+numberOfMonths,1),numberOfDaysInMonth=getNumberOfDaysInMonth(dateInTargetMonth);return numberOfDaysInMonth<date.getDate()?dateInTargetMonth.setDate(numberOfDaysInMonth):dateInTargetMonth.setDate(date.getDate()),dateInTargetMonth},getMonthDistance=function(start,end){return 12*(end.getFullYear()-start.getFullYear())+(end.getMonth()-start.getMonth())},getLastDateOfMonth=function(date){return new Date(date.getFullYear(),date.getMonth(),getNumberOfDaysInMonth(date))},isValidDate=function(date){return null!=date&&date.getTime&&!isNaN(date.getTime())},setDateTimeToMidnight=function(date){isValidDate(date)&&date.setHours(0,0,0,0)},createDateAtMidnight=function(opt_value){var date;return date=angular.isUndefined(opt_value)?new Date:new Date(opt_value),setDateTimeToMidnight(date),date},isDateWithinRange=function(date,minDate,maxDate){var dateAtMidnight=createDateAtMidnight(date),minDateAtMidnight=isValidDate(minDate)?createDateAtMidnight(minDate):null,maxDateAtMidnight=isValidDate(maxDate)?createDateAtMidnight(maxDate):null;return(!minDateAtMidnight||minDateAtMidnight<=dateAtMidnight)&&(!maxDateAtMidnight||maxDateAtMidnight>=dateAtMidnight)},isMinTimeBeforeMaxTime=function(minTime,maxTime,token){if(!token||"string"!=typeof token)return null;var minTimeArray=minTime.split(token).map(function(r){return Number.parseInt(r)}),maxTimeArray=maxTime.split(token).map(function(r){return Number.parseInt(r)});if(minTimeArray.length<3||maxTimeArray.length<3)return null;var minTimestamp=minTimeArray[2]+60*minTimeArray[1]+60*minTimeArray[0]*60,maxTimestamp=maxTimeArray[2]+60*maxTimeArray[1]+60*maxTimeArray[0]*60;return minTimestamp<=maxTimestamp},isTimeWithinRange=function(time,minTime,maxTime,token){if(!token||"string"!=typeof token)return null;var timeArray=time.split(token).map(function(r){return Number.parseInt(r)}),minTimeArray=minTime.split(token).map(function(r){return Number.parseInt(r)}),maxTimeArray=maxTime.split(token).map(function(r){return Number.parseInt(r)});if(minTimeArray.length<3||maxTimeArray.length<3||timeArray.length<3)return null;var timestamp=timeArray[2]+60*timeArray[1]+60*timeArray[0]*60,minTimestamp=minTimeArray[2]+60*minTimeArray[1]+60*minTimeArray[0]*60,maxTimestamp=maxTimeArray[2]+60*maxTimeArray[1]+60*maxTimeArray[0]*60;return timestamp<=maxTimestamp&&minTimestamp<=timestamp},isValidTime=function(time,token){return new RegExp("^([0-1]?[0-9]|2[0-3])"+token+"([0-5]?[0-9])"+token+"([0-5]?[0-9])$").test(time)},freeFormatDate=function(date,fmt){var o={"M+":date.getMonth()+1,"d+":date.getDate(),"H+":date.getHours(),"m+":date.getMinutes(),"s+":date.getSeconds(),"q+":Math.floor((date.getMonth()+3)/3),S:date.getMilliseconds()};/(y+)/.test(fmt)&&(fmt=fmt.replace(RegExp.$1,(""+date.getFullYear()).substr(4-RegExp.$1.length)));for(var k in o)new RegExp("("+k+")").test(fmt)&&(fmt=fmt.replace(RegExp.$1,1==RegExp.$1.length?o[k]:("00"+o[k]).substr((""+o[k]).length)));return fmt};return{getFirstDateOfMonth:getFirstDateOfMonth,getNumberOfDaysInMonth:getNumberOfDaysInMonth,getDateInNextMonth:getDateInNextMonth,getDateInPreviousMonth:getDateInPreviousMonth,isInNextMonth:isInNextMonth,isInPreviousMonth:isInPreviousMonth,getDateMidpoint:getDateMidpoint,isSameMonthAndYear:isSameMonthAndYear,getWeekOfMonth:getWeekOfMonth,incrementDays:incrementDays,incrementMonths:incrementMonths,getLastDateOfMonth:getLastDateOfMonth,isSameDay:isSameDay,getMonthDistance:getMonthDistance,isValidDate:isValidDate,setDateTimeToMidnight:setDateTimeToMidnight,createDateAtMidnight:createDateAtMidnight,isDateWithinRange:isDateWithinRange,isMinTimeBeforeMaxTime:isMinTimeBeforeMaxTime,isValidTime:isValidTime,isTimeWithinRange:isTimeWithinRange,getMonthsInSeason:getMonthsInSeason,freeFormatDate:freeFormatDate}}).factory("ModuleLoader",["$q","$ocLazyLoad","$compile","ScopeInitializer",function($q,$ocLazyLoad,$compile,ScopeInitializer){return{_loader:$ocLazyLoad,reload:function(file,selector,scope){var defer=$q.defer();return $ocLazyLoad.load(file).then(function(){selector&&"string"==typeof selector&&$compile(angular.element(selector))(scope),defer.resolve()},function(){ScopeInitializer.alert("组件初始化失败"),defer.reject()}),defer.promise}}}])});