"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();define(["clipboard","treeview","packagetree","string2json","../../services"],function(Clipboard){return["$rootScope","$scope","$http","$filter","$q","$cookies","$stateParams","$mdSidenav","$mdDialog","$timeout",function($rootScope,$scope,$http,$filter,$q,$cookies,$stateParams,$mdSidenav,$mdDialog,$timeout){var mode=$rootScope._param,modeCatId=$rootScope._cat_id;$rootScope.tab="API",$('a[href^="#"]',"#partials").click(function(e){e.preventDefault()});var _lang=$cookies.get("_lang"),beforeClipboardCopy="zh-cn"==_lang?"复制文档地址":"Copy document URL",afterClipboardCopy="zh-cn"==_lang?"已复制":"Copied",workaroundSupportClipboard=function(action){var actionMsg=" 来"+("cut"===action?"剪切":"拷贝"),actionKey="cut"===action?"X":"C";return actionMsg=/iPhone|iPad/i.test(navigator.userAgent)?"暂不支持iPhone和iPad :(":/Mac/i.test(navigator.userAgent)?"请按 ⌘-"+actionKey+actionMsg:"请按 Ctrl-"+actionKey+actionMsg};$scope.nav={entry:"api",subEntry:"",subDomains:[]},$scope.breadcrumbs=[],$scope.selectedEntry=0,$scope.defaultDetails={api_name:"API名字"},$scope.apiDetails=$scope.defaultDetails,$scope.domainDetails=$scope.defaultDetails,$scope.cat={cat_list:[],_selectedItem:0},$scope.clipboardHints=beforeClipboardCopy,$scope.makeDebugUrl=function(api){return Constant.protocol+"://"+Constant.host+"/ApiTool/index?sign="+api},$scope.makeSDKUrl=function(api){return Constant.protocol+"://"+Constant.host+"/welcome/sdkTool"},$scope.simpleAPILevelDescription=function(){};var catQ=(function(){function DynamicItems(list){_classCallCheck(this,DynamicItems),this.list=list,this.PAGE_SIZE=10,this.loadedPages={};for(var i=0;i<Math.ceil(this.list.length/this.PAGE_SIZE);i++)this.loadedPages[i]=[],this.loadedPages[i]=this.list.slice(i*this.PAGE_SIZE,(i+1)*this.PAGE_SIZE)}return _createClass(DynamicItems,[{key:"getItemAtIndex",value:function(index){var pageNumber=Math.floor(index/this.PAGE_SIZE),page=this.loadedPages[pageNumber];return page?page[index%this.PAGE_SIZE]:[]}},{key:"getLength",value:function(){return this.list.length}}]),DynamicItems}(),function(){return $http.post("/agent",{module:"supplier",partial:"API",api:"get_ssv_cat",param:{ssv_user_id:$rootScope.ssv_user_id}}).then(function(body){if($scope.originalCat={cat_list:body.data.cat_list,_selectedItem:0},body.data&&body.data.cat_list&&body.data.cat_list.length){if($scope.cat={cat_list:body.data.cat_list,_selectedItem:0},$scope.cat.cat_list)for(var j=0;j<$scope.cat.cat_list.length;j++)if($scope.cat.cat_list[j].group_list){$scope.cat.cat_list[j]._selectedItem=0,$scope.apiCategoryId==$scope.cat.cat_list[j].cat_id&&($scope.cat._selectedItem=j);for(var i=0;i<$scope.cat.cat_list[j].group_list.length;i++)if($scope.cat.cat_list[j].group_list[i].api_list)for(var k=0;k<$scope.cat.cat_list[j].group_list[i].api_list.length;k++)mode&&mode.apiMethod&&mode.apiMethod==$scope.cat.cat_list[j].group_list[i].api_list[k].api_id&&($scope.cat.cat_list[j]._selectedItem=i)}}else $scope.cat={cat_list:body.data.cat_list,_selectedItem:0},$rootScope.alert("当前供应商没有任何API发布")},function(why){$rootScope.alert(why)})}),apiQ=function(){return $http.post("/agent",{module:"supplier",partial:"API",api:"api_list",param:{ssv_user_id:$rootScope.ssv_user_id,cat_id:$scope.apiCategoryId}}).then(function(body){body.data&&body.data.data_list&&body.data.data_list.length?$scope.api_list=body.data.data_list:$rootScope.alert(body.data.msg)},function(why){$rootScope.alert(why)})},domainQ=function(){return $http.post("/agent",{module:"supplier",partial:"API",api:"api_domain",param:{ssv_user_id:$rootScope.ssv_user_id,cat_id:$scope.apiCategoryId}}).then(function(body){body.data&&body.data.data_list&&body.data.data_list.length?$scope.api_domain=body.data.data_list:$rootScope.alert(body.data.msg)},function(why){$rootScope.alert(why)})},domainDetailQ=function(domain_id,cat){var cat_id=cat.cat_id;return $scope.apiCategoryName=cat.cat_name,cat_id&&($scope.apiCategoryId=cat_id),$http.post("/agent",{module:"supplier",partial:"API",api:"domain_detail",param:{domain_id:domain_id}}).then(function(body){body.data&&body.data.data_list&&body.data.data_list.length?$scope.domainDetails=body.data.data_list[0]:$scope.domainDetails=$scope.defaultDetails,$scope.domainDetails.domain_desc&&($scope.domainDetails.domain_desc_expanded=!0),$scope.domainDetails.property&&($scope.domainDetails.property_expanded=!0);for(var j=$scope.cat._selectedItem,i=0;i<$scope.cat.cat_list[j].group_list.length;i++)if($scope.cat.cat_list[j]._domain_index=0,$scope.cat.cat_list[j].domain_list)for(var k=0;k<$scope.cat.cat_list[j].domain_list.length;k++)if($scope.cat.cat_list[j].domain_list[k].domain_id==$scope.domainDetails.domain_id){$scope.cat.cat_list[j]._domain_index=k;break}$scope.loading=!1;var type="anonymous";try{type=JSON.parse(getCookie("_session")).login_user_type}catch(e){}return bassdk.quick("setDefaultAttr"),bassdk.track("visit",{pageName:$scope.domainDetails.domain_name,userType:type,supplierName:$rootScope.ssv_intro.user_name,pageType:"结构统计"}),body},function(why){$rootScope.alert(why),$scope.loading=!1})};$scope.domainDetailQ=function(domain_id,cat){if(!$scope.loading){if($scope.loading=!0,$scope.apiCategoryId)return void $rootScope.scrollToTop(function(){domainDetailQ(domain_id,cat)});var cat_id=cat.cat_id;$scope.apiCategoryName=cat.cat_name,cat_id&&($scope.apiCategoryId=cat_id),setTimeout(function(){$rootScope.scrollToTop(function(){domainDetailQ(domain_id,cat)})},500)}};var apiDetailQ=function(api_id,cat){var cat_id=cat.cat_id;return $scope.apiCategoryName=cat.cat_name,cat_id&&($scope.apiCategoryId=cat_id),$rootScope.scrollToTop(),$http.post("/agent",{module:"supplier",partial:"API",api:"api_detail",param:{api_id:api_id}}).then(function(body){if(body.data&&body.data.data_list&&body.data.data_list.length?$scope.apiDetails=body.data.data_list[0]:$scope.apiDetails=$scope.defaultDetails,$scope.breadcrumbs=[$scope.apiDetails],$scope.apiDetails.api_id=api_id,$scope.apiDetails.api_desc&&($scope.apiDetails.api_desc_expanded=!0),$scope.apiDetails.sysparam_expanded=!1,$scope.apiDetails.request_parameter_type&&($scope.apiDetails.request_parameter_type_expanded=!0),$scope.apiDetails.request_parameter_example&&($scope.apiDetails.request_parameter_example_expanded=!0),$scope.apiDetails.response_parameter_desc&&($scope.apiDetails.response_parameter_desc_expanded=!0),$scope.apiDetails.response_parameter_example&&($scope.apiDetails.response_parameter_example_expanded=!0),$scope.apiDetails.busparam&&$scope.apiDetails.busparam.length&&($scope.apiDetails.busparam_expanded=!0),$scope.apiDetails.result&&$scope.apiDetails.result.length&&($scope.apiDetails.result_expanded=!0),$scope.apiDetails.return_example_xml&&($scope.apiDetails.return_example_xml_expanded=!0),$scope.apiDetails.error_example_xml_expanded=!1,$scope.apiDetails.buserror&&($scope.apiDetails.buserror_expanded=!0),$scope.apiDetails.syserror_expanded=!1,$scope.apiDetails.debug_expanded=!0,setTimeout(function(){var return_example_xml=$filter("unescapeHtml")($scope.apiDetails.return_example_xml,"xml"),error_example_xml=$filter("unescapeHtml")($scope.apiDetails.error_example_xml,"xml"),return_example_json=$filter("unescapeHtml")($scope.apiDetails.return_example_json,"xml"),error_example_json=$filter("unescapeHtml")($scope.apiDetails.error_example_json,"xml");packageTree(return_example_xml?return_example_xml:""),packageTreeError(error_example_xml?error_example_xml:""),Process(return_example_json?return_example_json:"{}"),ProcessError(error_example_json?error_example_json:"{}")}),mode)for(var j=$scope.cat._selectedItem,i=0;i<$scope.cat.cat_list[j].group_list.length;i++)if($scope.cat.cat_list[j].group_list[i]._api_index=0,$scope.cat.cat_list[j].group_list[i].api_list)for(var k=0;k<$scope.cat.cat_list[j].group_list[i].api_list.length;k++)if($scope.cat.cat_list[j].group_list[i].api_list[k].api_id==$scope.apiDetails.api_id){$scope.cat.cat_list[j].group_list[i]._api_index=k;break}mode=void 0,$scope.loading=!1;var type="anonymous";try{type=JSON.parse(getCookie("_session")).login_user_type}catch(e){}bassdk.quick("setDefaultAttr"),bassdk.track("visit",{pageName:$scope.apiDetails.api_name,userType:type,supplierName:$rootScope.ssv_intro.user_name,pageType:"API统计"})},function(why){$rootScope.alert(why),$scope.loading=!1})};$scope.apiDetailQ=function(api_id,cat){if(!$scope.loading){if($scope.loading=!0,$scope.apiCategoryId)return void $rootScope.scrollToTop(function(){apiDetailQ(api_id,cat)});var cat_id=cat.cat_id;$scope.apiCategoryName=cat.cat_name,cat_id&&($scope.apiCategoryId=cat_id),setTimeout(function(){$rootScope.scrollToTop(function(){apiDetailQ(api_id,cat)})},500)}},$scope.changeAPISearch=function(){if($scope.cat=JSON.parse(JSON.stringify($scope.originalCat)),$scope.cat.cat_list)for(var j=0;j<$scope.cat.cat_list.length;j++){if($scope.cat.cat_list[j].group_list)for(var i=0;i<$scope.cat.cat_list[j].group_list.length;i++)if($scope.cat.cat_list[j].group_list[i].api_list)for(var k=$scope.cat.cat_list[j].group_list[i].api_list.length;k--;)$scope.cat.cat_list[j].group_list[i].api_list[k].api_name.indexOf($scope.apiSearch)==-1&&$scope.cat.cat_list[j].group_list[i].api_list[k].api_title.indexOf($scope.apiSearch)==-1&&$scope.cat.cat_list[j].group_list[i].api_list.splice(k,1);if($scope.cat.cat_list[j].domain_list)for(var k=$scope.cat.cat_list[j].domain_list.length;k--;)$scope.cat.cat_list[j].domain_list[k].domain_name.indexOf($scope.apiSearch)==-1&&$scope.cat.cat_list[j].domain_list[k].domain_title.indexOf($scope.apiSearch)==-1&&$scope.cat.cat_list[j].domain_list.splice(k,1)}},$scope.resetView=function(){$scope.selectedEntry?(setTimeout(function(){$(".md-expand.active md-tab-item").eq(0).click()}),setTimeout(function(){$scope.param=void 0,$scope.breadcrumbs=[],!$scope.cat.cat_list&&catQ(),$scope.apiCategoryId=void 0,$scope.apiCategoryName=void 0},200)):($scope.param=void 0,$scope.breadcrumbs=[],!$scope.cat.cat_list&&catQ(),$scope.apiCategoryId=void 0,$scope.apiCategoryName=void 0)},mode?($scope.apiCategoryId=modeCatId,mode.apiMethod?catQ().then(function(){setTimeout(function(){$(".md-expand.active md-tab-item").eq(0).click()}),$scope.apiDetailQ(mode.apiMethod,$scope.cat.cat_list[$scope.cat._selectedItem])}):mode.domainMethod&&catQ().then(function(){setTimeout(function(){$(".md-expand.active md-tab-item").eq(1).click()}),$scope.domainDetailQ(mode.domainMethod,$scope.cat.cat_list[$scope.cat._selectedItem])})):catQ(),$scope.selectCategory=function(cat_id){$scope.selectedCatId=cat_id,apiQ(),domainQ()},$scope.selectEntry=function(entry){if($scope.selectedEntry=entry,!$scope.loading)if(entry){var lastBreadcrumb=$scope.breadcrumbs[$scope.breadcrumbs.length-1];lastBreadcrumb&&lastBreadcrumb.api_id&&$scope.defaultDetails!==$scope.domainDetails||!lastBreadcrumb?$scope.breadcrumbs.push($scope.domainDetails):$scope.domainDetails&&$scope.domainDetails.domain_id&&$scope.domainDetails.domain_id!=lastBreadcrumb.domain_id&&$scope.defaultDetails!==$scope.domainDetails&&$scope.breadcrumbs.push($scope.domainDetails)}else $scope.breadcrumbs.splice(0),$scope.apiDetails&&$scope.apiDetails.api_id&&$scope.defaultDetails!==$scope.apiDetails&&$scope.breadcrumbs.push($scope.apiDetails)},$scope.toSubDomain=function(id,details){if(!$scope.loading){if($scope.loading=!0,!id)return void console.log("toSubDomain: id = "+id+";detail="+JSON.stringify(details));if(details)$rootScope.scrollToTop(function(){$(".md-expand.active md-tab-item").eq(1).click(),setTimeout(function(){domainDetailQ(id,$scope.cat.cat_list[$scope.cat._selectedItem]).then(function(){var lastBreadcrumb=$scope.breadcrumbs[$scope.breadcrumbs.length-1];lastBreadcrumb&&(lastBreadcrumb.domain_id&&lastBreadcrumb.domain_id!=id||lastBreadcrumb.api_id)&&$scope.breadcrumbs.push($scope.domainDetails),$scope.loading=!1})},400)});else{var id_list=$scope.breadcrumbs.map(function(r,i){return r.api_id?r.api_id:r.domain_id}),subdomain_index=id_list.indexOf(id);$scope.breadcrumbs.splice(subdomain_index+1);var lastBreadcrumb=$scope.breadcrumbs[$scope.breadcrumbs.length-1];lastBreadcrumb.api_id?$rootScope.scrollToTop(function(){$(".md-expand.active md-tab-item").eq(0).click(),setTimeout(function(){apiDetailQ(id,$scope.cat.cat_list[$scope.cat._selectedItem]).then(function(){$scope.loading=!1})},400)}):$rootScope.scrollToTop(function(){$(".md-expand.active md-tab-item").eq(1).click(),setTimeout(function(){domainDetailQ(id,$scope.cat.cat_list[$scope.cat._selectedItem]).then(function(){$scope.loading=!1})},400)})}}},$scope.copyToClipboard=function(details){var id=details.api_id?details.api_id:details.domain_id,method=details.api_id?"ApiMethod":"ApiDomain";return Constant.protocol+"://"+Constant.host+"/api/"+method+"-"+id+".html"},$scope.levelHint=function($event){function DialogController($scope,$mdDialog){$scope.closeDialog=function(){$mdDialog.hide()}}$event.preventDefault(),$event.stopPropagation();angular.element(document.body);$mdDialog.show({targetEvent:$event,clickOutsideToClose:!0,fullscreen:!1,template:'\n                    <md-dialog aria-label="List dialog" class="level-description">\n                        <md-dialog-content style="padding: 32px;">\n                            <p><span style="font-size:12px;">开放平台API目前分为低级、中级、高级，根据API的等级不同，需要使用对应的调用方式。</span></p>        \n                            <p><md-button class="md-raised low-rank" aria-label="Settings">初级API</md-button>可以使用ACCESS_TOKEN模式和安全签名方式进行调用</p>\n                            <p><md-button class="md-raised medium-rank" aria-label="Settings">中级API</md-button>可以使用ACCESS_TOKEN模式和安全签名方式进行调用</p>\n                            <p><md-button class="md-raised high-rank" aria-label="Settings">高级API</md-button>只可以使用安全签名方式进行调用。</p>\n                            <br /> \n                            <p><span style="font-size:12px;">供应商在发布API时，目前系统会自动根据供应商安全等级分配API调用等级，后续版本将会开放供应商自行设置API调用等级。</span></p>\n                            <p><span style="font-size:12px;">当API调用等级比较低时，供应商应处理好服务器的调用安全性，确保数据的安全。</span></p>\n                            <p><span style="font-size:12px;">开发者在调用初级和中级API时，必须使用https方式进行调用，保证数据传输中的安全性。</span></p>\n                            <br />\n                            <p>具体调用方式请参照</p>\n                            <p><a href="http://open.rongcapital.cn/welcome/doc/4D41D81C-CBB1-4567-8D15-ACC16EE025C8" target="_blank">Secret签名模式调用API </a></p>\n                            <p><a href="http://open.rongcapital.cn/welcome/doc/1109A17A-5873-420E-A590-C4CE6C5A2D59" target="_blank">ACCESS_TOKEN模式调用API</a></p>\n                            <p><a href="http://open.rongcapital.cn/welcome/doc/792E3864-2481-42B9-9CD2-4D4B83F3B294" target="_blank">前端调用模式说明</a></p>\n                        </md-dialog-content>\n                        <md-dialog-actions>\n                            <md-button ng-click="closeDialog()" class="md-raised">关闭我</md-button>\n                        </md-dialog-actions>\n                    </md-dialog>',controller:DialogController})},$scope.getScrollIndex=function(list,type){return type?$scope.apiDetails&&$scope.apiDetails.api_id?[].concat.apply([],list.map(function(r,i){return $scope.apiDetails.api_id==r.api_id?[i]:[]}))[0]:0:$scope.domainDetails&&$scope.domainDetails.domain_id?[].concat.apply([],list.map(function(r,i){return $scope.domainDetails.domain_id==r.domain_id?[i]:[]}))[0]:0};var cliper=new Clipboard(".cliper");cliper.on("success",function(e){e.clearSelection(),$scope.clipboardHints=afterClipboardCopy,$timeout(function(){$scope.clipboardHints=beforeClipboardCopy},3e3)}),cliper.on("error",function(e){$scope.clipboardHints=workaroundSupportClipboard(e.action),$timeout(function(){$scope.clipboardHints=beforeClipboardCopy},5e3)}),$scope.injectorLoaded=!0,$rootScope.removeLoading()}]});