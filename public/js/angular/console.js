"use strict";var consoleApp=angular.module("ConsoleApp",["ui.router","ngAnimate","ngCookies","ngMaterial","ngMessages"]);consoleApp.config(function($mdThemingProvider){var customBlueMap=$mdThemingProvider.extendPalette("cyan",{contrastDefaultColor:"light",contrastDarkColors:["50"],50:"ffffff",300:"00C8AB",500:"00C5A3",800:"00A589",A100:"EEFCFF"});$mdThemingProvider.definePalette("customBlue",customBlueMap),$mdThemingProvider.theme("default").primaryPalette("customBlue",{"default":"500","hue-1":"50","hue-2":"800","hue-3":"A100"}).accentPalette("pink");var greyMap=$mdThemingProvider.extendPalette("grey",{contrastDefaultColor:"dark",contrastDarkColors:["50"],contrastLightColors:["300","500","800","A100"],50:"FFFFFF",300:"35383B",500:"2b2b2b",800:"212121",A100:"000000"});$mdThemingProvider.definePalette("amazingPaletteName",greyMap),$mdThemingProvider.theme("dracular").primaryPalette("amazingPaletteName",{"default":"500","hue-1":"50","hue-2":"300","hue-3":"800"})}),consoleApp.config(function($mdIconProvider){$mdIconProvider.iconSet("action","/vendor/material-design-icons/sprites/svg-sprite/svg-sprite-action.svg",24).iconSet("alert","/vendor/material-design-icons/sprites/svg-sprite/svg-sprite-alert.svg",24).iconSet("av","/vendor/material-design-icons/sprites/svg-sprite/svg-sprite-av.svg",24).iconSet("communication","/vendor/material-design-icons/sprites/svg-sprite/svg-sprite-communication.svg",24).iconSet("content","/vendor/material-design-icons/sprites/svg-sprite/svg-sprite-content.svg",24).iconSet("device","/vendor/material-design-icons/sprites/svg-sprite/svg-sprite-device.svg",24).iconSet("editor","/vendor/material-design-icons/sprites/svg-sprite/svg-sprite-editor.svg",24).iconSet("file","/vendor/material-design-icons/sprites/svg-sprite/svg-sprite-file.svg",24).iconSet("hardware","/vendor/material-design-icons/sprites/svg-sprite/svg-sprite-hardware.svg",24).iconSet("image","/vendor/material-design-icons/sprites/svg-sprite/svg-sprite-image.svg",24).iconSet("maps","/vendor/material-design-icons/sprites/svg-sprite/svg-sprite-maps.svg",24).iconSet("navigation","/vendor/material-design-icons/sprites/svg-sprite/svg-sprite-navigation.svg",24).iconSet("notification","/vendor/material-design-icons/sprites/svg-sprite/svg-sprite-notification.svg",24).iconSet("social","/vendor/material-design-icons/sprites/svg-sprite/svg-sprite-social.svg",24).iconSet("toggle","/vendor/material-design-icons/sprites/svg-sprite/svg-sprite-toggle.svg",24).defaultIconSet("/vendor/material-design-icons/sprites/svg-sprite/svg-sprite-action.svg",24)}),consoleApp.config(["$stateProvider","$urlRouterProvider","$locationProvider","$httpProvider",function($stateProvider,$urlRouterProvider,$locationProvider,$httpProvider){$stateProvider.state("index",{templateUrl:"/_view/console/index",controller:"IndexCtrl",url:"/console/home"}),$urlRouterProvider.otherwise("/console/home"),$locationProvider.html5Mode(!0),$locationProvider.hashPrefix("!")}]),consoleApp.controller("ConsoleCtrl",["$rootScope","$scope","$state","$location","$window","$http","$cookies","$mdDialog",function($rootScope,$scope,$state,$location,$window,$http,$cookies,$mdDialog){$rootScope.removeLoading=function(){$(".loading").hasClass("out")||($(".loading").addClass("start"),setTimeout(function(){$(".loading").addClass("out").one($.support.transition.end,function(){$(this).hide(),$("body").addClass("reveal")})},ROPStyleConstant.loadingTime))},$rootScope._entry="0",$rootScope.switchFrame=function(subentry,url,title){$rootScope._subentry=subentry,$rootScope._title=title,$("#mainFrameWrapper").animate({scrollTop:0}),$("#mainFrameWrapper")[0].innerHTML='<iframe id="mainFrame" src=/frame/'+url+' scrolling="no" width="100%" style="min-height:800px;" noresize="noresize" marginwidth="0" marginheight="0" frameborder="0" class=""></iframe>'},$rootScope.toggleEntry=function(index){$rootScope._entry!=index?$rootScope._entry=index:$rootScope._entry=-1,setTimeout(function(){$(".nano").nanoScroller()},500)},$rootScope.locate=function(url){$window.location.href=url},$rootScope.toPlatform=function(path){$scope.locate(Constant.protocol+"://"+Constant.host+":"+Constant.port+(path?path:""))},$rootScope.toWelcome=function(){$scope.locate(Constant.protocol+"://"+Constant.host+":"+Constant.port)},$rootScope.logout=function(){return $http.post("/agent",{module:"sso",partial:"session",api:"quit"}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?($cookies.put("_session",null,{path:"/",domain:""+(Constant.nosubdomain?"":".")+Constant.host}),$cookies.remove("_session",{path:"/",domain:""+(Constant.nosubdomain?"":".")+Constant.host}),$window.location.href="sso?from=console"):console.log(body.msg)},function(why){console.log(body.msg)})},$rootScope.go=function(tab){$state.go(tab)},$rootScope.isAdmin=function(){!(!$rootScope.profile||"0"!=$rootScope.profile.login_user_type&&"3"!=$rootScope.profile.login_user_type)},$rootScope.isSsv=function(){!(!$rootScope.profile||"2"!=$rootScope.profile.login_user_type)},$rootScope.alert=function(msg){$mdDialog.show($mdDialog.alert().clickOutsideToClose(!0).title("出错了").textContent(msg).ariaLabel(msg).ok("了解"))},$rootScope.checkSession=function(){var _session=$cookies.get("_session")?JSON.parse($cookies.get("_session")):"";return _session&&!$rootScope.profile&&document.querySelector("meta[name=session]").content==_session.id&&($rootScope.profile=_session),!(!_session||!$rootScope.profile)||($rootScope.profile=void 0,$cookies.remove("_session",{path:"/",domain:""+(Constant.nosubdomain?"":".")+Constant.host}),!1)},$rootScope.getSystemHints=function(){var source=new EventSource("/sse/common/tips");source.onmessage=function(e){var body=JSON.parse(e.data);return body._closeSSE?void source.close():void(body._skipSSE||("boolean"==typeof body.is_success&&body.is_success||"string"==typeof body.is_success&&"true"==body.is_success?$rootScope.systemHints=body.data_list:(console.log(body.msg),source.close()),$rootScope.$apply()))},window.addEventListener("beforeunload",function(event){source.close()})},$scope.init=function(){return $rootScope.checkSession()?($rootScope.removeLoading(),$rootScope.getSystemHints(),setTimeout(function(){$(".nano").nanoScroller(),window.addEventListener("message",function(e){"expired"==e.data&&$rootScope.logout()})},800),void $state.go("index")):void $rootScope.logout()}}]),consoleApp.controller("IndexCtrl",["$rootScope","$scope","$http","$mdSidenav","$compile","$element",function($rootScope,$scope,$http,$mdSidenav,$compile,$element){$rootScope.tab="index",$scope.toggleSidenav=function(){$mdSidenav("right").toggle()},$scope.fetchSysMsg=function(){$http.post("/agent",{module:"console",partial:"consoles",api:"secret-reset"}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?$scope.systemHints=body.data.appsecret:console.log(body.data.msg)},function(why){$rootScope.alert(why)})},$scope.hasHint=function(){return $scope.systemHints&&$scope.systemHints.length},$scope.pageindex=1,$scope.items=[],$scope.unappApiCheckedList=[],$scope.appApiCheckedList=[],$scope.appApiList=[],$scope.unappApiList=[],$scope.secretReset=function(){$http.post("/agent",{module:"console",partial:"consoles",api:"secret-reset",param:{app_id:$scope.appDetails.app_id}}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?$scope.appDetails.appsecret=body.data.appsecret:console.log(body.msg)},function(why){console.log(why)})},$scope.testSecretReset=function(){$http.post("/agent",{module:"console",partial:"consoles",api:"test-secret-reset",param:{app_id:$scope.appDetails.app_id}}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?$scope.appDetails.test_appsecret=body.data.test_appsecret:console.log(body.msg)},function(why){console.log(why)})},$scope.tokenReset=function(){$http.post("/agent",{module:"console",partial:"consoles",api:"token-reset",param:{app_id:$scope.appDetails.app_id}}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?$scope.appDetails.access_token=body.data.access_token:console.log(body.msg)},function(why){console.log(why)})},$scope.testTokenReset=function(){$http.post("/agent",{module:"console",partial:"consoles",api:"test-token-reset",param:{app_id:$scope.appDetails.app_id}}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?$scope.appDetails.test_access_token=body.data.test_access_token:console.log(body.msg)},function(why){console.log(why)})},$scope.viewApp=function(app){$http.post("/agent",{module:"console",partial:"consoles",api:"details",param:{app_id:app.app_id}}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?($scope.appDetails=body.data,!$scope.appDetails.app_id&&($scope.appDetails.app_id=app.app_id),$.extend(app,$scope.appDetails),$("#app_info").modal()):console.log(body.msg)},function(why){console.log(why)})},$scope.viewEdit=function(app){$http.post("/agent",{module:"console",partial:"consoles",api:"details",param:{app_id:app.app_id}}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?($scope.appDetails=body.data,!$scope.appDetails.app_id&&($scope.appDetails.app_id=app.app_id),$.extend(app,$scope.appDetails),$("#app_update").modal()):console.log(body.msg)},function(why){console.log(why)})},$scope.viewApi=function(app){$scope.appSelected=app,$scope.apiSearcher($scope.apiPageIndex,$scope.apiPageSize,function(){$("#api_list").modal()})},$scope.viewUnApi=function(e){var $btn=$(e.currentTarget).button("loading");$scope.unapiSearcher($scope.unapiPageIndex,$scope.unapiPageSize,function(){$("#unapi_list").modal(),$btn.button("reset")})},$scope.viewCreate=function(){$scope.appDetails={},$("#app_create").modal()},$scope.load=function(){},$scope.editApp=function(){$http.post("/agent",{module:"console",partial:"consoles",api:"edit",param:{app_id:$scope.appDetails.app_id,app_name:$scope.appDetails.app_name,remark:$scope.appDetails.remark,user_type:$scope.profile.login_user_type}}).then(function(body){if("boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success){var app=[].concat.apply([],$scope.items.map(function(item,i){return item.app_id==body.data.app_id?[item]:[]}));app&&$.extend(app,body.data)}else console.log(body.msg);$("#app_update").modal("hide")},function(why){console.log(why)})},$scope.$on("$viewContentLoaded",function(event){$scope.load(),setTimeout(function(){$(".md-sidenav-left .md-expand:first-child md-list md-list-item:first-child button").click()})}),$scope.apiPageIndex=1,$scope.apiPageSize=5,$scope.apiRefresh=function(cb){$scope.apiPageIndex=1,$scope.apiPageSize=5,$scope.apiSearcher(null,null,cb)},$scope.apiSearcher=function(index,size,cb){$scope.appSelected&&$http.post("/agent",{module:"console",partial:"consoles",api:"api",param:$.extend({app_id:$scope.appSelected.app_id,pageindex:index?index:$scope.apiPageIndex,pagesize:size?size:$scope.apiPageSize},$scope.apiSearchParam)}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?($scope.appApiList=body.data.app_api_list,$scope.apiTotal=Number.parseInt(body.data.list_count),$scope.appApiCheckedList.splice(0,$scope.appApiCheckedList.length),cb&&cb.call()):console.log(body.msg)},function(why){console.log(why),cb&&cb.call()})},$scope.toggleAllApi=function(){$scope.appApiCheckedList.length&&$scope.appApiCheckedList.length==$scope.appApiList.length?$scope.appApiCheckedList.splice(0,$scope.appApiCheckedList.length):$scope.appApiList.forEach(function(api){$scope.appApiCheckedList.indexOf(api)==-1&&$scope.appApiCheckedList.push(api)})},$scope.toggleApi=function(api){$scope.appApiCheckedList.indexOf(api)==-1?$scope.appApiCheckedList.push(api):$scope.appApiCheckedList.splice($scope.appApiCheckedList.indexOf(api),1)},$scope.deleteApi=function(){$http.post("/agent",{module:"console",partial:"consoles",api:"delete-api",param:{app_id:$scope.appSelected.app_id,api_id:$scope.appApiCheckedList.map(function(item){return item.api_id}).join("@")}}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?$scope.apiRefresh():console.log(body.msg)},function(why){console.log(why)})},$scope.allApiChecked=function(){return 0==[].concat.apply([],$scope.appApiList.map(function(item){return $scope.appApiCheckedList.indexOf(item)==-1?[item]:[]})).length},$scope.unapiPageIndex=1,$scope.unapiPageSize=5,$scope.unapiRefresh=function(cb){$scope.unapiPageIndex=1,$scope.unapiPageSize=5,$scope.unapiSearcher(null,null,cb)},$scope.unapiSearcher=function(index,size,cb){$scope.appSelected&&$http.post("/agent",{module:"console",partial:"consoles",api:"unapi",param:$.extend({app_id:$scope.appSelected.app_id,pageindex:index?index:$scope.unapiPageIndex,pagesize:size?size:$scope.unapiPageSize},$scope.apiSearchParam)}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?($scope.unappApiList=body.data.app_api_list,$scope.unapiTotal=Number.parseInt(body.data.list_count),$scope.unappApiCheckedList.splice(0,$scope.unappApiCheckedList.length),cb&&cb.call()):console.log(body.msg)},function(why){console.log(why),cb&&cb.call()})},$scope.toggleAllUnApi=function(){$scope.unappApiCheckedList.length&&$scope.unappApiCheckedList.length==$scope.unappApiList.length?$scope.unappApiCheckedList.splice(0,$scope.unappApiCheckedList.length):$scope.unappApiList.forEach(function(api){$scope.unappApiCheckedList.indexOf(api)==-1&&$scope.unappApiCheckedList.push(api)})},$scope.toggleUnApi=function(api){$scope.unappApiCheckedList.indexOf(api)==-1?$scope.unappApiCheckedList.push(api):$scope.unappApiCheckedList.splice($scope.unappApiCheckedList.indexOf(api),1)},$scope.addUnApi=function(){$http.post("/agent",{module:"console",partial:"consoles",api:"add-api",param:{app_id:$scope.appSelected.app_id,api_id:$scope.unappApiCheckedList.map(function(item){return item.api_id}).join("@")}}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?$scope.apiRefresh(function(){$("#unapi_list").modal("hide")}):console.log(body.msg)},function(why){console.log(why)})},$scope.allUnApiChecked=function(){return 0==[].concat.apply([],$scope.unappApiList.map(function(item){return $scope.unappApiCheckedList.indexOf(item)==-1?[item]:[]})).length},$scope.$on("$viewContentLoaded",function(event){})}]),consoleApp.filter("escapeHtml",function(){var entityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};return function(str){return String(str).replace(/[&<>"'\/]/g,function(s){return entityMap[s]})}}),consoleApp.filter("unescapeHtml",function(){var entityMap={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&#x2F;":"/"};return function(str,type){if(str){var rawStr=String(str).replace(/(&amp;|&lt;|&gt;|&quot;|&#39;|&#x2F;)/g,function(s){return entityMap[s]});if(str&&"undefined"!=str){if("json"==type)return JSON.stringify(JSON.parse(rawStr),null,2);if("xml"==type)return formatXml(rawStr)}return rawStr}}}),consoleApp.filter("trusthtml",["$sce",function($sce){return function(t){return $sce.trustAsHtml(t)}}]),consoleApp.directive("ropPagination",["$parse",function($parse){return{restrict:"A",scope:{index:"=index",size:"=size",total:"=total",searcher:"=searcher"},templateUrl:"/_template/pagination",link:function($scope,element,attrs){$scope.myIndex=$scope.index,$scope.ceilingIndex=$scope.index+4,$scope.$watch("total",function(){$scope.pages=[];for(var i=0;i<Math.ceil($scope.total/$scope.size);i++)$scope.pages.push({index:i+1})}),$scope.$watch("size",function(){$scope.pages=[];for(var i=0;i<Math.ceil($scope.total/$scope.size);i++)$scope.pages.push({index:i+1});$scope.index=1,$scope.ceilingIndex=5,$scope.searcher($scope.index,$scope.size)}),$scope.toFirst=function(){$scope.index=1,$scope.ceilingIndex=5,$scope.searcher($scope.index,$scope.size)},$scope.toLast=function(){$scope.index=$scope.pages.length,$scope.ceilingIndex=$scope.pages.length,$scope.searcher($scope.index,$scope.size)},$scope.searchPrevious=function(){$scope.ceilingIndex==$scope.index+4&&$scope.index>1&&$scope.ceilingIndex--,$scope.index>1&&(--$scope.index,$scope.searcher($scope.index,$scope.size))},$scope.searchNext=function(){$scope.ceilingIndex==$scope.index&&$scope.index<$scope.pages.length&&$scope.ceilingIndex++,$scope.index<$scope.pages.length&&(++$scope.index,$scope.searcher($scope.index,$scope.size))},$scope.searchIndex=function(i){$scope.index=i,$scope.searcher($scope.index,$scope.size)},$scope.toPage=function(myIndex){$scope.ceilingIndex=Math.min(Number.parseInt(myIndex)+4,$scope.pages.length),$scope.searchIndex(myIndex)}}}}]),consoleApp.directive("ropTreeView",["$compile",function($compile){return{restrict:"AE",scope:{data:"=data",field:"=field",option:"=option"},replace:!0,templateUrl:"/js/angular/template/tree_view.html",link:function($scope,element,attrs){try{$scope.data=JSON.parse(attrs.data)}catch(e){$scope.data=$scope.$parent[attrs.data]}var recur=function recur(item,runner){item[$scope.field.children]&&item[$scope.field.children].length&&item[$scope.field.children].forEach(function(subItem){runner(subItem,item),recur(subItem,runner)})},recur_counter=function recur_counter(item,checked){var allUnchecked=!0;item[$scope.field.children]&&item[$scope.field.children].forEach(function(brother){checked?!brother[$scope.field.checked]&&(allUnchecked=!1):brother[$scope.field.checked]&&(allUnchecked=!1)}),allUnchecked&&(item[$scope.field.checked]=checked,item._parent&&recur_counter(item._parent,checked))},watcher=function(){!$scope.option&&($scope.option={}),$scope.field&&(!$scope.field.id&&($scope.field.id="_id"),!$scope.field.label&&($scope.field.id="_label"),!$scope.field.children&&($scope.field.children="_children"),!$scope.field.checked&&($scope.field.checked="_checked"),!$scope.field.collapsed&&($scope.field.collapsed="_collapsed")),$scope.data&&$scope.data.forEach(function(item){item[$scope.field.children]&&item[$scope.field.children].length&&($scope.option.collapseAll?item[$scope.field.collapsed]=!0:item[$scope.field.collapsed]=!1),recur(item,function(node,parent){node._parent=parent,node[$scope.field.children]&&node[$scope.field.children].length&&($scope.option.collapseAll?node[$scope.field.collapsed]=!0:node[$scope.field.collapsed]=!1)})})};$scope.$watch("data",function(){watcher()}),window.test=$scope.$parent,$scope.$parent.RopTreeView={},$scope.$parent.RopTreeView.getChecked=function(){var list=[];return $scope.data&&$scope.data.forEach(function(item){item[$scope.field.checked]&&list.push(item),recur(item,function(node){node[$scope.field.checked]&&list.push(node)})}),list},$scope.toggleChecked=function(item){item[$scope.field.checked]=!item[$scope.field.checked],recur(item,function(node){node[$scope.field.checked]=item[$scope.field.checked]}),item[$scope.field.checked]?item._parent&&(item._parent[$scope.field.checked]=item[$scope.field.checked],item._parent._parent&&(item._parent._parent[$scope.field.checked]=item[$scope.field.checked])):item._parent&&recur_counter(item._parent,!1)},$scope.toggleCollapse=function(item){item[$scope.field.collapsed]=!item[$scope.field.collapsed]}}}}]);