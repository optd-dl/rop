"use strict";define(["require","angular"],function(require,angular){var controllerModule=angular.module("sso.controllers",[]);controllerModule.controller("IndexCtrl",["$rootScope","$scope","$http","$window","$cookies","$timeout",function($rootScope,$scope,$http,$window,$cookies,$timeout){$rootScope.tab="index",$scope.login_msg="";var captcha_img="/captcha?l=50&_l=1",rememberMistakes=function(){if($rootScope.loginMistakes++,$rootScope.loginMistakes>2){var today=new Date;$cookies.put("_showCaptcha",!0,{path:"/",domain:""+(Constant.nosubdomain?"":".")+Constant.host,expires:new Date(today.getFullYear(),today.getMonth(),today.getDate()+1)})}},forgetMistakes=function(){$cookies.put("_showCaptcha","",{path:"/",domain:""+(Constant.nosubdomain?"":".")+Constant.host}),$cookies.remove("_showCaptcha",{path:"/",domain:""+(Constant.nosubdomain?"":".")+Constant.host})};$scope.captcha_img=captcha_img+"&time="+(new Date).getTime(),$scope.clearMsg=function(){$scope.login_msg=""},$scope.login=function(){if(!$scope.refreshing){if($scope.loginForm.$invalid)return $scope.loginForm.$error.required&&$scope.loginForm.$error.required.forEach(function(r){r.$setDirty(!0)}),$("#loginPanel").addClass("invalid"),$timeout(function(){$("#loginPanel").removeClass("invalid"),$scope.login_msg="zh-cn"==$rootScope._lang?"请检查输入项是否正确":"Please verify the inputs"},600),void rememberMistakes.call();var OSName="Unknown OS";navigator.appVersion.indexOf("Win")!=-1&&(OSName="Windows"),navigator.appVersion.indexOf("Mac")!=-1&&(OSName="MacOS"),navigator.appVersion.indexOf("X11")!=-1&&(OSName="UNIX"),navigator.appVersion.indexOf("Linux")!=-1&&(OSName="Linux");var myParam={user_account:$scope.user_account?$scope.user_account.trim():"",password:$scope.password?$scope.password.trim():"",login_system:OSName};$scope.refreshing=!0,$http.post("/agent",{module:"sso",partial:"session",api:"login",param:myParam}).then(function(body){if("boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success){if($rootScope.profile=body.data,$cookies.put("_session",JSON.stringify($rootScope.profile),{path:"/",domain:""+(Constant.nosubdomain?"":".")+Constant.host}),forgetMistakes.call(),bassdk){var sign="";try{sign=JSON.parse(getCookie("_session")).sign}catch(e){}bassdk.userIdentify(sign,!0)}$rootScope.from?"application"==$rootScope.from?$rootScope.isSsv()?$rootScope.toPlatform($rootScope.from):$rootScope.isAdmin()?$rootScope.toPlatform("console"):$rootScope.isIsv&&$rootScope.toPlatform("console"):"console"==$rootScope.from&&($rootScope.isSsv()?$rootScope.toPlatform("application"):$rootScope.isAdmin()?$rootScope.toPlatform("console"):$rootScope.isIsv&&$rootScope.toPlatform("console")):$rootScope.toPlatform("")}else rememberMistakes.call(),$("#loginPanel").addClass("invalid"),$timeout(function(){$("#loginPanel").removeClass("invalid"),$scope.login_msg=body.data.msg},600)},function(why){$scope.login_msg=why})["finally"](function(){$timeout(function(){$scope.refreshing=!1})})}},$scope.resetCaptcha=function(){$scope.captchaCode="",$scope.captcha_img=captcha_img+"&time="+(new Date).getTime()},$scope.clearMsg=function(){$scope.login_msg=""},$scope.verifyCode=function(){var _captcha=$cookies.get("_captcha");return _captcha?$scope.captchaCode&&$scope.captchaCode.toLowerCase()==$cookies.get("_captcha").toLowerCase():void $scope.resetCaptcha()},$scope.$on("$viewContentLoaded",function(event){setTimeout(function(){$("#inputPassword").attr("type","password").val(""),$rootScope.removeLoading()})})}]).controller("RegisterCtrl",["$rootScope","$scope","$http",function($rootScope,$scope,$http){$rootScope.tab="register",$scope.ssv_msg="",$scope.dev_msg="",$scope.chooseType=function(type){$scope.userType=type},window.test=function(type){$scope.userType=type,$scope.$apply()},$scope.clearMsg=function(type){2==type?$scope.ssv_msg="":$scope.dev_msg=""},$scope.register=function(ev){var type=$scope.userType;if(2==type){if($scope.ssvForm.$invalid)return $scope.ssvForm.$error.required&&$scope.ssvForm.$error.required.forEach(function(r){r.$setDirty(!0)}),$("#ssvRegisterPanel").addClass("invalid"),void setTimeout(function(){$("#ssvRegisterPanel").removeClass("invalid"),$scope.ssv_msg="zh-cn"==$rootScope._lang?"请检查输入项是否正确":"Please verify the inputs",$scope.$apply()},600);$http.post("/agent",{module:"sso",partial:"register",api:"regist",param:$.extend({user_type:type},$scope.ssv)}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?($scope.ssv._success=!0,$scope.ssv_msg="zh-cn"==$rootScope._lang?"注册成功，请登录注册邮箱查看本站发送的邮件，并按邮件提示激活账户":"Success, please proceed to your mailbox and active your account"):(console.log(body.data.msg),$scope.ssv_msg=body.data.msg)},function(why){$scope.ssv_msg=why})}else{if($scope.devForm.$invalid)return $scope.devForm.$error.required&&$scope.devForm.$error.required.forEach(function(r){r.$setDirty(!0)}),$("#devRegisterPanel").addClass("invalid"),void setTimeout(function(){$("#devRegisterPanel").removeClass("invalid"),$scope.dev_msg="zh-cn"==$rootScope._lang?"请检查输入项是否正确":"Please verify the inputs",$scope.$apply()},600);$http.post("/agent",{module:"sso",partial:"register",api:"regist",param:$.extend({user_type:type},$scope.developer)}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?($scope.developer._success=!0,$scope.dev_msg="zh-cn"==$rootScope._lang?"注册成功，请登录注册邮箱查看本站发送的邮件，并按邮件提示激活账户":"Success, please proceed to your mailbox and active your account"):(console.log(body.data.msg),$scope.dev_msg=body.data.msg)},function(why){$scope.dev_msg=why})}},$scope.$on("$viewContentLoaded",function(event){setTimeout(function(){$("input.password").attr("type","password").val("")}),$rootScope.removeLoading()})}]).controller("UpdateCtrl",["$rootScope","$scope","$http",function($rootScope,$scope,$http){$rootScope.profile||($rootScope.alertDialog(null,{title:"zh-cn"==$rootScope._lang?"跳转失败":"Failed",content:"zh-cn"==$rootScope._lang?"用户没有登录，无法取得个人信息":"No signed in yet",ariaLabel:"zh-cn"==$rootScope._lang?"跳转失败":"Failed",ok:"Ok"}),$rootScope.go("index")),$rootScope.tab="update",$scope.update_msg="",$scope.clearMsg=function(type){$scope.update_msg=""},$scope.init=function(){$http.post("/agent",{module:"sso",partial:"update",api:"getuser"}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?($scope.initialData=JSON.parse(JSON.stringify(body.data)),"2"!=$rootScope.profile.login_user_type?$scope.developer=body.data:$scope.ssv=body.data):(console.log(body.data.msg),$scope.update_msg=body.data.msg)},function(why){$scope.update_msg=why})},$scope.reset=function(){$scope.developer?$scope.developer=$scope.initialData:$scope.ssv=$scope.initialData},$scope.update=function(ev){if($scope.ssv){if($scope.ssvForm.$invalid)return $scope.ssvForm.$error.required&&$scope.ssvForm.$error.required.forEach(function(r){r.$setDirty(!0)}),$("#ssvRegisterPanel").addClass("invalid"),void setTimeout(function(){$("#ssvRegisterPanel").removeClass("invalid"),$scope.update_msg="zh-cn"==$rootScope._lang?"请检查输入项是否正确":"Please verify the inputs",$scope.$apply()},600);$http.post("/agent",{module:"sso",partial:"update",api:"saveuser",param:$.extend({user_type:$rootScope.profile.login_user_type},$scope.ssv)}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?($scope.ssv._success=!0,$scope.update_msg="修改成功"):(console.log(body.data.msg),$scope.update_msg=body.data.msg)},function(why){$scope.update_msg=why})}else{if($scope.devForm.$invalid)return $scope.devForm.$error.required&&$scope.devForm.$error.required.forEach(function(r){r.$setDirty(!0)}),$("#devRegisterPanel").addClass("invalid"),void setTimeout(function(){$("#devRegisterPanel").removeClass("invalid"),$scope.update_msg="zh-cn"==$rootScope._lang?"请检查输入项是否正确":"Please verify the inputs",$scope.$apply()},600);$http.post("/agent",{module:"sso",partial:"update",api:"saveuser",param:$.extend({user_type:$rootScope.profile.login_user_type},$scope.developer)}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?($scope.developer._success=!0,$scope.update_msg="zh-cn"==$rootScope._lang?"修改成功":"DONE"):(console.log(body.data.msg),$scope.update_msg=body.data.msg)},function(why){$scope.update_msg=why})}},$scope.init(),$scope.$on("$viewContentLoaded",function(event){$rootScope.removeLoading()})}]).controller("UpdatepasswordCtrl",["$rootScope","$scope","$http",function($rootScope,$scope,$http){$rootScope.tab="updatepassword",$scope.update_msg="",$scope.clearMsg=function(type){$scope.update_msg=""},$scope.update=function(ev){return $scope.userForm.$invalid?($scope.userForm.$error.required&&$scope.userForm.$error.required.forEach(function(r){r.$setDirty(!0)}),$("#userPanel").addClass("invalid"),void setTimeout(function(){$("#userPanel").removeClass("invalid"),$scope.update_msg="zh-cn"==$rootScope._lang?"请检查输入项是否正确":"Please verify the inputs",$scope.$apply()},600)):void $http.post("/agent",{module:"sso",partial:"updatepassword",api:"updatepassword",param:$.extend({user_type:$rootScope.profile.login_user_type},$scope.user)}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?($scope.user._success=!0,$scope.update_msg="zh-cn"==$rootScope._lang?"修改成功":"DONE"):(console.log(body.data.msg),$scope.update_msg=body.data.msg)},function(why){$scope.update_msg=why})},$scope.$on("$viewContentLoaded",function(event){$rootScope.removeLoading()})}]).controller("FindpasswordCtrl",["$rootScope","$scope","$http","$mdDialog",function($rootScope,$scope,$http,$mdDialog){$rootScope.tab="findpassword",$scope.reset_msg="";var captcha_img="/captcha?l=50&_l=1";$scope.captcha_img=captcha_img,$scope.clearMsg=function(){$scope.reset_msg=""},$scope.resetmail=function(ev){return $scope.findForm.$invalid?($scope.findForm.$error.required&&$scope.findForm.$error.required.forEach(function(r){r.$setDirty(!0)}),$("#findpasswordPanel").addClass("invalid"),void setTimeout(function(){$("#findpasswordPanel").removeClass("invalid"),$scope.reset_msg="zh-cn"==$rootScope._lang?"请检查输入项是否正确":"Please verify the inputs",$scope.$apply()},600)):void $http.post("/agent",{module:"sso",partial:"findpassword",api:"findpassword",param:$scope.param}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?($scope.param._success=!0,$scope.reset_msg="zh-cn"==$rootScope._lang?"邮件发送成功, 请打开注册邮箱激活新密码":"Please open your mailbox and active the new password"):(console.log(body.data.msg),$scope.reset_msg=body.data.msg)},function(why){$scope.reset_msg=why})},$scope.resetCaptcha=function(){$scope.captcha="",$scope.captcha_img=captcha_img+"&time="+(new Date).getTime()},$scope.verifyCode=function(){var _captcha=$cookies.get("_captcha");return _captcha?$scope.captchaCode&&$scope.captcha.toLowerCase()==$cookies.get("_captcha").toLowerCase():void $scope.resetCaptcha()},$scope.$on("$viewContentLoaded",function(event){setTimeout(function(){$rootScope.removeLoading()})})}]).controller("ResetpasswordCtrl",["$rootScope","$scope","$http","$stateParams","$interval",function($rootScope,$scope,$http,$stateParams,$interval){$rootScope.tab="resetpassword",$scope.param={},$scope.param._remaining=5,$scope.reset_msg="";var stop=void 0;$scope.clearMsg=function(){$scope.reset_msg=""},$scope.resetpassword=function(ev){if(!$scope.refreshing){if($scope.resetForm.$invalid)return $scope.resetForm.$error.required&&$scope.resetForm.$error.required.forEach(function(r){r.$setDirty(!0)}),$("#resetPanel").addClass("invalid"),setTimeout(function(){$("#resetPanel").removeClass("invalid"),$scope.reset_msg="zh-cn"==$rootScope._lang?"请检查输入项是否正确":"Please verify the inputs",$scope.$apply()},600),void $scope.param._remaining--;$scope.refreshing=!0,$http.post("/agent",{module:"sso",partial:"resetpassword",api:"resetpassword",param:{reset_code:$stateParams.token,new_password:$scope.param.new_password}}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?($scope.param._success=!0,$scope.reset_msg="zh-cn"==$rootScope._lang?"密码重置成功":"Password reset!",$scope.refreshing=!1,$scope.secondsRemaining=5,stop=$interval(function(){0==$scope.secondsRemaining?$rootScope.go("index"):$scope.secondsRemaining--},1e3)):($scope.param._error=!0,$scope.reset_msg=body.data.msg,$scope.refreshing=!1)},function(why){$scope.reset_msg=why})}},$scope.$on("$viewContentLoaded",function(event){setTimeout(function(){$rootScope.removeLoading()})}),$scope.$on("$destroy",function(){$interval.cancel(stop)})}]).controller("ActiveUserCtrl",["$rootScope","$scope","$http","$window","$state","$stateParams",function($rootScope,$scope,$http,$window,$state,$stateParams){$rootScope.tab="activeUser",$scope.secondsRemaining=5,$scope.msg="zh-cn"==$rootScope._lang?"处理中......":"Processing...",$http.post("/agent",{module:"sso",partial:"activeuser",api:"list",param:{active_key:$stateParams.code}}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?!function(){$scope.msg="zh-cn"==$rootScope._lang?"账号激活成功":"Account actived";var mark=setInterval(function(){$scope.secondsRemaining?($scope.secondsRemaining--,$scope.$apply()):(clearInterval(mark),$scope.go("index"))},1e3)}():($scope.msg="zh-cn"==$rootScope._lang?"账号激活失败，原因如下":"Active failed",$scope.error=body.data.msg,console.log(body.data.msg))},function(why){$scope.msg="zh-cn"==$rootScope._lang?"账号激活失败，原因如下":"Active failed",$scope.error=why}),$scope.$on("$viewContentLoaded",function(event){$rootScope.removeLoading()})}])});