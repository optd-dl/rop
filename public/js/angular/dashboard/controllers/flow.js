"use strict";define([],function(){return["$rootScope","$scope","$q","$http","$mdDialog",function($rootScope,$scope,$q,$http,$mdDialog){function initApiFilter(){return $scope.loading=!0,$rootScope.ajax("flow_filter_init").then(function(data){$scope.cat_list=[{cat_id:"",cat_name:"全部类型"}].concat(data.cat_list),$scope.currentCat=$scope.cat_list[0],$scope.status_list=[{status_id:"",status_name:"全部状态"}].concat(data.status_list),$scope.currentStatus=$scope.status_list[0]})["finally"](function(){$scope.loading=!1})}function initApiViewUser(api){return $scope.refreshing=!0,$scope.user_list=[{user_id:"",user_name:"全部开发者"}],$scope.currentUser=$scope.user_list[0],$rootScope.ajax("flow_isv_filter_init",{api_id:api&&api.api_id}).then(function(data){data&&"true"===data.is_success&&($scope.user_list=$scope.user_list.concat(data.user_list))})}$rootScope.tab="flow";var initApiFilterQ=void 0,initApiViewUserQ=void 0;$scope.reset=function(){$scope.api_list=[],$scope.cat_list=[],$scope.status_list=[],$scope.user_list=[],$scope.app_list=[],$scope.currentCat={},$scope.currentStatus={},$scope.currentApi={},$scope.keyword="",$scope.pageIndex=1,$scope.pageSize=new Number(10),$scope.mode=0,initApiFilterQ=initApiFilter()},$scope.reset(),$scope.research=function(){$scope.pageIndex=1,$scope.pageSize=new Number(10)},$scope.selectCat=function(cat){$scope.currentCat=cat,$scope.research()},$scope.selectUser=function(user){$scope.currentUser=user,$scope.pageIndex2=1,$scope.pageSize2=new Number(10)},$scope.selectStatus=function(status){$scope.currentStatus=status,$scope.research()},$scope.searcher=function(index,size){if(!$scope.refreshing){$scope.refreshing=!0;var previous=$scope.api_list&&$scope.api_list._select;return initApiFilterQ.then(function(){return $rootScope.ajax("flow_list_get",{pageindex:index?index:$scope.pageIndex,pagesize:size?size:$scope.pageSize,api_name:$scope.keyword?$scope.keyword:"",cat_id:$scope.currentCat&&$scope.currentCat.cat_id,status:$scope.currentStatus&&$scope.currentStatus.status_id}).then(function(data){"boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success?($scope.api_list=data.data_list,$scope.api_list&&$scope.api_list[0]&&(previous?$scope.api_list._select=[].concat.apply([],$scope.api_list.map(function(r){return previous.api_id==r.api_id?[r]:[]}))[0]:$scope.api_list._select=$scope.api_list[0]),$scope.total=data.list_count):($rootScope.alert(data.msg),$scope.total=0)})["finally"](function(){$scope.refreshing=!1})})}};var Controller=function(scope,item){scope.item=item;var isApp=!!item.app_id;scope.save=function(){if(!scope.refreshing)return scope.configForm.$invalid?(scope.configForm.$error.required&&scope.configForm.$error.required.forEach(function(r){r.$setDirty(!0)}),scope.configForm.$error.validUnicodeLength&&scope.configForm.$error.validUnicodeLength.forEach(function(r){r.$setDirty(!0)}),scope.configForm.$error.maxlength&&scope.configForm.$error.maxlength.forEach(function(r){r.$setDirty(!0)}),void(scope.error="请检查输入是否正确")):(scope.refreshing=!0,$rootScope.ajax(isApp?"flow_isv_detail_save":"flow_detail_save",{api_id:scope.item.api_id,flow_switch:scope.item.flow_switch,minute_count:scope.item.minute_count,hour_count:scope.item.hour_count,day_count:scope.item.day_count,app_id:isApp?scope.item.app_id:void 0}).then(function(data){return data&&"true"===data.is_success?(isApp?$scope.searcher2():$scope.searcher(),void scope.close()):(scope.error=data.msg,$q.reject(data.msg))},function(why){return scope.error=why,$q.reject(why)})["finally"](function(){scope.refreshing=!1}))},scope.resetCount=function(){scope.item&&"0"==scope.item.flow_switch&&(scope.item.minute_count="0",scope.item.hour_count="0",scope.item.day_count="0")},scope.close=function(){return $mdDialog.hide()}};$scope.showDialog=function(event,item){if($scope.refreshing)return $q.reject();$scope.refreshing=!0;var isApp=!!item.app_id;return $rootScope.ajax(isApp?"flow_isv_detail_get":"flow_detail_get",{api_id:isApp?$scope.currentApi&&$scope.currentApi.api_id:item&&item.api_id,app_id:isApp&&item?item.app_id:void 0}).then(function(data){data&&"true"===data.is_success&&$mdDialog.show({controller:Controller,template:template,parent:angular.element("body>section>md-content"),targetEvent:event,clickOutsideToClose:!0,locals:{item:data.api_flow}})})["finally"](function(){$scope.refreshing=!1})},$scope.showAppView=function(api){$scope.currentApi=api,$scope.user_list=[],$scope.app_list=[],$scope.pageIndex2=1,$scope.pageSize2=new Number(10),initApiViewUserQ=initApiViewUser($scope.currentApi),$scope.mode=1},$scope.searcher2=function(index,size){return $scope.refreshing=!0,initApiViewUserQ.then(function(){return $rootScope.ajax("flow_isv_list_get",{pageindex:index?index:$scope.pageIndex2,pagesize:size?size:$scope.pageSize2,api_id:$scope.currentApi&&$scope.currentApi.api_id,user_id:$scope.currentUser&&$scope.currentUser.user_id}).then(function(data){data&&"true"===data.is_success?($scope.app_list=data.data_list,$scope.total2=data.list_count):($rootScope.alert(data.msg),$scope.total2=0)})["finally"](function(){$scope.refreshing=!1})})},$scope.hideAppView=function(){$scope.mode=0};var template='\n            <md-dialog aria-label="API流量管理" class="form" aria-describedby="quick edit">\n              <md-toolbar>\n                <div class="md-toolbar-tools">\n                  <md-icon md-svg-icon="navigation:ic_apps_24px"></md-icon>\n                  <h3><span ng-bind="\'API流量控制\'"></span></h3>\n                  <md-button class="md-icon-button md-primary md-hue-1" aria-label="Settings" ng-click="close()">\n                    <md-icon md-svg-icon="content:ic_clear_24px"></md-icon>\n                  </md-button>\n                </div>\n              </md-toolbar>\n              <md-dialog-content>\n                <form class="md-dialog-content postfix-input" name="configForm" autocomplete="off">\n                  <div class="input-container">\n                    <label>流量控制开关</label>\n                    <md-radio-group ng-model="item.flow_switch" ng-init="item.flow_swtich = \'0\'" ng-change="resetCount()">\n                        <md-radio-button value="1" class="md-primary">开</md-radio-button>\n                        <md-radio-button value="0" class="md-primary">关</md-radio-button>\n                    </md-radio-group>\n                  </div>\n                  <div class="input-container">\n                    <label>调用次数（每分钟）</label>\n                    <input type="text" name="minute" maxlength="6" ng-model="item.minute_count" \n                    ng-pattern="\'([0]|[1-9]\\\\d{0,5})\'" ng-disabled="item.flow_switch === \'0\'" required/>\n                    <span>次</span>\n                  </div>\n                  <div class="input-container">\n                    <label>调用次数（每小时）</label>\n                    <input type="text" name="hour" maxlength="6" ng-model="item.hour_count" ng-pattern="\'([0]|[1-9]\\\\d{0,5})\'" ng-disabled="item.flow_switch === \'0\'" required/>\n                    <span>次</span>\n                  </div>\n                  <div class="input-container">\n                    <label>调用次数（每天）</label>\n                    <input type="text" name="day" maxlength="6" ng-model="item.day_count" ng-pattern="\'([0]|[1-9]\\\\d{0,5})\'" ng-disabled="item.flow_switch === \'0\'" required/>\n                    <span>次</span>\n                  </div>\n                </form>\n                <div class="app-loading" ng-if="refreshing">\n                  <md-progress-circular md-mode="indeterminate"></md-progress-circular>\n                </div>\n              </md-dialog-content>\n              <md-dialog-actions layout="row">\n                <div class="message" ng-if="error">\n                  <span ng-bind="error"></span>\n                </div>\n                <md-button ng-click="save()" type="submit">保存</md-button>\n              </md-dialog-actions>\n            </md-dialog>';$scope.injectorLoaded=!0,window.test=$scope}]});