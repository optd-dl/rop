"use strict";function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}define([],function(){return["$rootScope","$scope","$http","$mdDialog","$q",function($rootScope,$scope,$http,$mdDialog,$q){$rootScope.tab="api",$scope.mode=0,$scope.enterMode=function(mode,cb){$scope.mode=mode,cb&&cb.call()},$scope.exitMode=function(cb){$scope.mode=0,cb&&cb.call()},$scope.toggleFilterPanel=function(e){$scope.showFilterPanel=!$scope.showFilterPanel,$scope.showBatchPanel=!1},$scope.toggleBatchPanel=function(e){$scope.showBatchPanel=!$scope.showBatchPanel,$scope.showFilterPanel=!1},$scope.$watch("batch",function(){$scope.batch&&($scope.showFilterPanel=!0)}),$scope.orders=[{name:"ruixue.external.items.get",cat:"商品API",des:"1.获取商品数据 注：不填写查询参数时默认为查询所有的商品信息。"},{name:"ruixue.external.items.get",cat:"商品API",des:"2.获取商品数据 注：不填写查询参数时默认为查询所有的商品信息。"},{name:"ruixue.external.items.get",cat:"商品API",des:"3.获取商品数据 注：不填写查询参数时默认为查询所有的商品信息。"}];var ExportController=function(scope,$mdDialog){scope.test_url="0",scope.online_url="0";var exportFile=function(){return scope.exporting=!0,$rootScope.ajax("api_export",{keyword:$scope.keyword,cat_id:$scope.panelSelection.panelCat.cat_id,group_id:$scope.panelSelection.panelCatGroup.group_id,status:$scope.panelSelection.panelStatus.status_id,sort_name:$scope.panelSelection.sorter.name,sort_flag:$scope.panelSelection.sorter.sort,test_url:scope.test_url,online_url:scope.online_url},function(data){if("Chrome"==$rootScope.browserType){var a=window.document.createElement("a");a.href=data.export_url,a.download=!0,a.click()}else window.open(data.export_url,"_blank");return scope.exporting=!1,data})};scope.triggerExport=function(){scope.exporting||exportFile().then(function(data){data&&$mdDialog.hide()})},scope.closeExport=function(){$mdDialog.hide()}};$scope.showExport=function(ev){$mdDialog.show({controller:ExportController,template:'<md-dialog aria-label="Mango (Fruit)" style="width: 256px">\n                                <md-dialog-content class="md-dialog-content">\n                                    <div class="md-dialog-content-body">\n                                        <md-checkbox ng-model="test_url" aria-label="Checkbox 1" class="md-primary" ng-true-value="\'1\'" ng-false-value="\'0\'" >测试URL</md-checkbox>\n                                        <md-checkbox ng-model="online_url" aria-label="Checkbox 2" class="md-primary" ng-true-value="\'1\'" ng-false-value="\'0\'" >正式URL</md-checkbox>\n                                    </div>\n                                </md-dialog-content>\n                                <md-dialog-actions layout="row">\n                                  <md-button ng-click="closeExport()">\n                                    取消\n                                  </md-button>\n                                  <md-button ng-click="triggerExport()">\n                                   导出\n                                  </md-button>\n                                </md-dialog-actions>\n                            </md-dialog>',parent:angular.element(document.querySelector("body>section>md-content")),targetEvent:ev,clickOutsideToClose:!0})},$scope.panelSelection={};var initCat={cat_id:"",cat_name:"全部分类"},initGroup={group_id:"",group_name:""},initStatus={status_id:"",status_name:"全部状态"};$scope.reset=function(){$scope.panelSelection.panelCat={cat_id:"",cat_name:"全部分类"},$scope.panelSelection.panelCatGroup={group_id:"",group_name:""},$scope.panelSelection.panelStatus=initStatus,$scope.panelSelection.sorter={name:"",sort:"1"},$scope.columns=[{text:"API标题",name:"api_title",tooltip:!0,sort:"1"},{text:"API名称",name:"api_name",tooltip:!0,sort:"1",linker:{create:function(row){return Constant.protocol+"://"+Constant.host+":"+Constant.port+"/api/ApiPreview-"+row.api_id+".html"},target:"_blank"}},{text:"API类型",name:"cat_id",style:{width:"128px","text-align":"center"}},{text:"状态",name:"status_name",tooltiper:function(row){return"101"==row.status||"103"==row.status||"105"==row.status?row.refuse_reason:""},style:{width:"96px","text-align":"center"}},{text:"停用状态",name:"use_yn",style:{width:"88px","text-align":"center"}},{text:"添加时间",name:"create_time",sort:"1",style:{width:"160px","text-align":"center"}}],$scope.keyword="",$scope.batch=!1,$scope.pageIndex=1,$scope.pageSize=new Number(10)},$scope.reset(),$scope.chooseCat=function(cat,group){$scope.panelSelection.panelCat=cat?cat:{cat_id:"",cat_name:"全部分类"},$scope.panelSelection.panelCatGroup=group?group:initGroup,$scope.pageIndex=1,$scope.pageSize=new Number(10)},$scope.chooseStatus=function(status){$scope.panelSelection.panelStatus=status?status:{status_id:"",status_name:"全部状态"},$scope.pageIndex=1,$scope.pageSize=new Number(10)},$scope.searcher=function(index,size){return $scope.refreshing=!0,$rootScope.ajax("api_list",{pageindex:index?index:$scope.pageIndex,pagesize:size?size:$scope.pageSize,keyword:$scope.keyword,cat_id:$scope.panelSelection.panelCat.cat_id,group_id:$scope.panelSelection.panelCatGroup.group_id,status:$scope.panelSelection.panelStatus.status_id,sort_name:"create_time"==$scope.panelSelection.sorter.name?"rx_insertTime":$scope.panelSelection.sorter.name,sort_flag:$scope.panelSelection.sorter.sort},function(data){"boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success?($scope.tableData=data.data_list,$scope.total=data.list_count):($rootScope.alert(data.msg),$scope.total=0)},function(){$scope.total=0})["finally"](function(){$scope.refreshing=!1})},$scope.tableData=[],$scope.research=function(){$scope.pageIndex=1,$scope.pageSize=new Number(10)};$rootScope.ajax("init",function(data){$scope.originalPanel=JSON.parse(JSON.stringify(data)),$scope.panel=data});$scope.canVisistAPI=function(){return $scope.tableData&&$scope.tableData._select},$scope.canRemindAPI=function(){return $scope.tableData&&$scope.tableData._select&&"4"==$scope.tableData._select.status},$scope.canInsertAPI=function(){return $scope.panel&&"1"==$scope.panel.role_list.btnInsert},$scope.canInsertFrontAPI=function(){return $scope.panel&&"1"==$scope.panel.role_list.btnFrontInsert},$scope.canVisitCacheAPI=function(){return $scope.panel&&"1"==$scope.panel.role_list.btnCache&&$scope.tableData&&$scope.tableData._select},$scope.canApplyAuditAPI=function(array){if(!array||!array.length||!array[0]||$scope.panel&&"0"==$scope.panel.role_list.btnApplyApi)return!1;var result=!0;return array.forEach(function(r,i){("0"!=r.status&&"101"!=r.status||"0"!=r.is_old)&&(result=!1)}),result},$scope.canDeleteAPI=function(array){if(!array||!array.length||!array[0]||$scope.panel&&"0"==$scope.panel.role_list.btnDelete)return!1;var result=!0;return array.forEach(function(r,i){("0"!=r.status&&"1"!=r.status&&"2"!=r.status||"0"!=r.is_old)&&(result=!1)}),result},$scope.canUpdateAPI=function(array){if(!array||!array.length||!array[0]||$scope.panel&&"0"==$scope.panel.role_list.btnUpdate)return!1;var result=!0;return array.forEach(function(r,i){("0"!=r.status&&"1"!=r.status&&"2"!=r.status&&"3"!=r.status&&"6"!=r.status&&"101"!=r.status&&"103"!=r.status||"0"!=r.is_old)&&(result=!1)}),result},$scope.canApplyPromoteAPI=function(array){if(!array||!array.length||!array[0]||$scope.panel&&"0"==$scope.panel.role_list.btnApplyApi)return!1;var result=!0;return array.forEach(function(r,i){("2"!=r.status&&"6"!=r.status&&"103"!=r.status||"0"!=r.is_old)&&(result=!1)}),result},$scope.canApplyUpdateAPI=function(array){if(!array||!array.length||!array[0]||$scope.panel&&"0"==$scope.panel.role_list.btnApplyApi)return!1;var result=!0;return array.forEach(function(r,i){("4"!=r.status||"0"!=r.is_old)&&(result=!1)}),result},$scope.canRecallAPI=function(array){if(!array||!array.length||!array[0]||$scope.panel&&"0"==$scope.panel.role_list.btnCancel)return!1;var result=!0;return array.forEach(function(r,i){("6"!=r.status&&"106"!=r.status||"0"!=r.is_old)&&(result=!1)}),result},$scope.canRestoreAPI=function(array){if(!array||!array.length||!array[0]||$scope.panel&&"0"==$scope.panel.role_list.btnScrap)return!1;var result=!0;return array.forEach(function(r,i){("107"!=r.status||"0"!=r.is_old)&&(result=!1)}),result},$scope.canDumpAPI=function(array){if(!array||!array.length||!array[0]||$scope.panel&&"0"==$scope.panel.role_list.btnScrap)return!1;var result=!0;return array.forEach(function(r,i){("4"!=r.status||"0"!=r.is_old)&&(result=!1)}),result},$scope.checkedRows=function(){var data=$scope.tableData;if(!data||!data.length||!data[0])return[];var filtered=[].concat.apply([],data.map(function(r,i){return r._checked?[r]:[]}));return filtered},$scope.deleteAPI=function(row){return $rootScope.confirm("请确认是否要删除API？",function(){return $rootScope.ajax("delete_api",{api_id:row.api_id},function(data){$scope.research(),$rootScope.warn("删除成功",1)})})},$scope.applyAPI=function(row,status){return"5"==status?$rootScope.confirm("数据为<"+row.status_name+">状态，确定要申请修改吗？",function(){return $rootScope.ajax("apply_api",{api_id:row.api_id,status:status},function(data){return $scope.searcher(),$rootScope.warn("申请成功",1),data})}):$rootScope.ajax("apply_api",{api_id:row.api_id,status:status},function(data){return $scope.searcher(),$rootScope.warn("申请成功",1),data})},$scope.recallAPI=function(row){return $rootScope.ajax("cancel_api",{api_id:row.api_id},function(data){$scope.searcher(),$rootScope.warn("撤销成功",1)})},$scope.restoreAPI=function(row){return $rootScope.ajax("recover_api",{api_id:row.api_id},function(data){$scope.searcher(),$rootScope.warn("恢复成功",1)})},$scope.dumpAPI=function(row){return $rootScope.confirm("请确认是否要废弃API？",function(){return $rootScope.ajax("dump_api",{api_id:row.api_id},function(data){$scope.searcher(),$rootScope.warn("废弃成功",1)})})},$scope.batchSaveAPI=function(apply_type){var rows=$scope.checkedRows(),status=rows.map(function(r,i){return r.status_name}),uniqueStatus=[].concat(_toConsumableArray(new Set(status))),statusString=uniqueStatus.join("/"),operationString="2"==apply_type?"批量上线":"3"==apply_type?"批量申请修改":"4"==apply_type?"批量撤销":"批量操作";return $rootScope.confirm("数据为<"+statusString+">状态,您确定要进行<"+operationString+">吗？",function(){var apiIDs=rows.map(function(r,i){return{api_id:r.api_id}});return $rootScope.ajax("batch_save",{apply_type:apply_type,api_list:apiIDs},function(data){$scope.research(),$rootScope.warn(operationString+"成功",1)})})};var ReminderController=function(scope,api,user_list,unique_id){scope.original_user_list=user_list,scope.user_list=user_list,scope.columns=[{text:"开发者名称",name:"user_name",style:{"text-align":"center",width:"328px"}}],scope.multiple=!0,scope.dialogId=unique_id,scope.filter=function(){var candidateList=[].concat.apply([],scope.user_list.map(function(r,i){return scope.keyword&&r.user_name.indexOf(scope.keyword)!=-1?(r._highlight=!0,[i]):(r._highlight=!1,[])})),index=candidateList[0];scope.index=index},scope.filterNext=function(e){e.preventDefault(),e.stopPropagation();for(var candidateList=[].concat.apply([],scope.user_list.map(function(r,i){return r.user_name.indexOf(scope.keyword)!=-1?[i]:[]})),index=candidateList[0],i=0;i<candidateList.length;i++)if(candidateList[i]>scope.index){index=candidateList[i];break}scope.index=index},scope.send=function(){if(!scope.refreshing){var list=[].concat.apply([],scope.user_list.map(function(r,i){return r._checked?[{user_id:r.user_id}]:[]}));return list.length?(scope.refreshing=!0,$http.post("/agent",{module:"application",partial:"api",api:"reminder_send",param:{api_id:api.api_id,user_list:list}}).then(function(body){return"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?(scope.closeReminder(),body.data):(scope.error=body.data.msg,$q.reject(body.data.msg))},function(why){return scope.error=why,$q.reject(why)})["finally"](function(){scope.refreshing=!1})):void(scope.error="请选择至少一位开发者进行变更提醒")}},scope.closeReminder=function(){$mdDialog.hide()}};$scope.reminder=function(ev,api){if(!$scope.refreshing)return $scope.refreshing=!0,$rootScope.ajax("reminder_developers",{api_id:api.api_id},function(data){data.user_list&&data.user_list.length?$mdDialog.show({controller:ReminderController,template:'\n                                <md-dialog aria-label="用户提醒" class="reminder" aria-describedby="reminder" id="{{dialogId}}">\n                                    <md-toolbar>\n                                        <div class="md-toolbar-tools">\n                                            <h3><span>变更提醒</span></h3>\n                                            <md-icon class="" md-svg-icon="action:ic_info_24px">\n                                                <md-tooltip md-direction="down">当API信息发生变更时，供应商可以手动选择需要被提醒的相关开发者，发送提醒邮件</md-tooltip>\n                                            </md-icon>\n                                            <md-button class="md-icon-button md-primary md-hue-1" aria-label="Settings" ng-click="closeReminder()">\n                                                <md-icon md-svg-icon="content:ic_clear_24px"></md-icon>\n                                            </md-button>\n                                        </div>\n                                    </md-toolbar>\n                                \n                                    <md-dialog-content>\n                                        <div class="md-dialog-content" >\n                                            <form class="search-wrapper" ng-submit="filterNext($event)">\n                                                <div class="search-group">\n                                                    <button type="submit">\n                                                        <md-icon class="md-primary" md-svg-icon="action:ic_search_24px" ng-click="filterNext($vent)"></md-icon>\n                                                    </button>\n                                                    <input type="text" class="searcher" ng-model="keyword" placeholder="请输入关键字......" ng-change="filter()"/>\n                                                </div>\n                                            </form>\n                                            <div class="table-wrapper">\n                                                <rop-fixed-table cols="columns" data="user_list" cursor="index" keyword="keyword" multiple="multiple"/>\n                                                <div class="app-loading" ng-if="refreshing">\n                                                    <md-progress-circular md-mode="indeterminate"></md-progress-circular>\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </md-dialog-content>\n                                    \n                                    <md-dialog-actions layout="row">\n                                        <div class="message" ng-if="error">\n                                            <span ng-bind="error"></span>\n                                        </div>\n                                      <md-button ng-click="send()">发送</md-button>\n                                    </md-dialog-actions>\n                                </md-dialog>\n                            ',autoWrap:!1,targetEvent:ev,clickOutsideToClose:!0,parent:angular.element(document.querySelector("body>section>md-content")),locals:{api:api,user_list:data.user_list,unique_id:(new Date).getTime()}}):$rootScope.alert("当前API尚未有任何开发者使用，无需变更提醒")})["finally"](function(){$scope.refreshing=!1})};var initialUpdaterAPI={api_name:"",api_rank:"0",timeout:"30",is_noserver:"0",api_title:"",api_title_en:"",api_desc:"",api_desc_en:"",return_example_xml:"",return_example_json:"",test_url:"",online_url:"",busparam:[{is_must:"0"},{is_must:"0"},{is_must:"0"},{is_must:"0"},{is_must:"0"}],buserror:[{},{},{},{},{}],result:[{},{},{},{},{}]},initialSteps=[{name:"基本信息"},{name:"请求参数"},{name:"返回结果"},{name:"错误代码"}],initialClientSteps=[{name:"基本信息"},{name:"错误代码"}],initAPIQ=void 0;$scope.lowerCharcodes=[190].concat(_toConsumableArray([].concat(_toConsumableArray(Array(26).keys())).map(function(r){return r+65}))),$scope.updaterAPI=JSON.parse(JSON.stringify(initialUpdaterAPI)),$scope.step=0,$scope.steps=initialSteps,$scope.updaterSelection={panelCat:initCat,panelCatGroup:initGroup},$scope.step1Tab=0,$scope.selectStep1Tab=function(value){$scope.step1Tab=value},$scope.initAPI=function(row){return $rootScope.ajax("api_init",{},function(data){return $scope.apiInit=data,$scope.apiInit&&$scope.apiInit.environment.length&&$scope.apiInit.environment.forEach(function(r){!r.url&&(r.url="")}),initialUpdaterAPI.environment_url=$scope.apiInit.environment,$scope.updaterAPI.environment_url=JSON.parse(JSON.stringify($scope.apiInit.environment)),$scope.apiInit&&$scope.apiInit.cat_list&&$scope.apiInit.cat_list[0]?(initCat=$scope.apiInit.cat_list[0],void($scope.apiInit.cat_list[0].group_list&&$scope.apiInit.cat_list[0].group_list[0]&&(initGroup=$scope.apiInit.cat_list[0].group_list[0]))):$q.reject("该账号暂无任何可操作的API分类，请完成审核流程并添加API分类")})},initAPIQ=$scope.initAPI(),$scope.addAPIMode=function(mode){$scope.step1Tab=0,initAPIQ&&initAPIQ.then(function(data){$scope.mode=mode,$scope.updaterSelection.panelCat=initCat,$scope.updaterSelection.panelCatGroup=initGroup,0!=$scope.step&&($scope.step=0),1==mode?($scope.steps=initialSteps,$scope.updaterAPI.call_flag="0"):($scope.steps=initialClientSteps,$scope.updaterAPI.call_flag="1"),$rootScope.ajax("api_datatype",{cat_id:$scope.updaterSelection.panelCat.cat_id},function(data){$scope.resultDataTypes=data.data_type_list})},function(e){$rootScope.alert(e)})},$scope.updateAPIMode=function(forView){return $scope.step1Tab=0,$scope.updaterAPI.api_id="fake",initAPIQ&&initAPIQ.then(function(data){return $scope.apiInit&&$scope.apiInit.cat_list?$rootScope.ajax("api_info",{api_id:$scope.tableData._select.api_id},function(data){"0"==data.api_info.call_flag?($scope.mode=1,$scope.steps=initialSteps):($scope.mode=4,$scope.steps=initialClientSteps),0!=$scope.step&&($scope.step=0),$scope.originalUpdaterAPI=JSON.parse(JSON.stringify(data.api_info)),angular.extend($scope.updaterAPI,data.api_info),forView&&($scope.updaterAPI._forView=forView),$scope.updaterSelection.panelCat=[].concat.apply([],$scope.apiInit.cat_list.map(function(r){return r.cat_id==$scope.updaterAPI.cat_id?[r]:[]}))[0],!$scope.updaterSelection.panelCat&&($scope.updaterSelection.panelCat=initCat),$scope.updaterSelection.panelCat.group_list&&$scope.updaterSelection.panelCat.group_list[0]&&($scope.updaterSelection.panelCatGroup=[].concat.apply([],$scope.updaterSelection.panelCat.group_list.map(function(r){return r.group_id==$scope.updaterAPI.group_id?[r]:[]}))[0]),(!$scope.updaterSelection.panelCatGroup||!$scope.updaterSelection.panelCatGroup.group_id)&&($scope.updaterSelection.panelCatGroup=initGroup),$rootScope.ajax("api_datatype",{cat_id:$scope.updaterSelection.panelCat.cat_id},function(data){$scope.resultDataTypes=data.data_type_list})}):void $rootScope.alert("API没有分类信息")})},$scope.nextStep=function(){if($scope.updaterAPI._forView)return void($scope.step<3&&$scope.step++);if(1==$scope.mode){if(!$scope.nextKeyPressed&&($scope.nextKeyPressed=!0),$scope.updaterAPIForm.$invalid){for(var pattern in $scope.updaterAPIForm.$error)$scope.updaterAPIForm.$error[pattern].forEach(function(r){r.$setDirty(!0)});return}$scope.step<3&&$scope.step++}else if(4==$scope.mode){if(!$scope.frontEndNextKeyPressed&&($scope.frontEndNextKeyPressed=!0),$scope.updaterFrontEndAPIForm.$invalid){for(var _pattern in $scope.updaterFrontEndAPIForm.$error)$scope.updaterFrontEndAPIForm.$error[_pattern].forEach(function(r){r.$setDirty(!0)});return}$scope.step<3&&$scope.step++}},$scope.previousStep=function(){$scope.step>0&&$scope.step--},$scope.cancelStep=function(){$scope.updaterAPI=JSON.parse(JSON.stringify(initialUpdaterAPI)),1==$scope.mode?($scope.nextKeyPressed=!1,$scope.updaterAPIForm.$setPristine()):4==$scope.mode&&($scope.frontEndNextKeyPressed=!1,$scope.updaterFrontEndAPIForm.$setPristine()),$scope.mode=0,$scope.step=0,$scope.step1Tab=0,$scope.updaterSelection={panelCat:initCat,panelCatGroup:initGroup}},$scope.chooseUpdaterCat=function(cat,group){$rootScope.confirm("修改API类别会导致 [结构属性信息] 类型中含有结构属性的数据清空，确定修改API类别吗",function(){$scope.updaterSelection.panelCat=cat?cat:initCat,$scope.updaterAPI.cat_id=$scope.updaterSelection.panelCat.cat_id,$scope.updaterSelection.panelCat.group_list&&$scope.updaterSelection.panelCat.group_list[0]?$scope.updaterSelection.panelCatGroup=$scope.updaterSelection.panelCat.group_list[0]:$scope.updaterSelection.panelCatGroup=initGroup,$rootScope.ajax("api_datatype",{cat_id:$scope.updaterSelection.panelCat.cat_id},function(data){$scope.resultDataTypes=data.data_type_list})})},$scope.chooseUpdaterGroup=function(group){$scope.updaterSelection.panelCatGroup=group?group:initGroup,$scope.updaterAPI.group_id=$scope.updaterSelection.panelCatGroup.group_id},$scope.processResultDataType=function(data_type,result){var systemDataTypes=$scope.apiInit.data_type_list.map(function(r){return r.data_type});if(result._customized=systemDataTypes.indexOf(data_type)==-1,data_type!=result.param_type&&(result.param_type=data_type),result._customized){var param_name=void 0;if("1"==result.is_list){param_name=result.param_type?result.param_type.toLowerCase()+"s":"";var second_param_name=result.param_type?result.param_type.toLowerCase():"";result.second_node!=second_param_name&&(result.second_node=second_param_name)}else param_name=result.param_type?result.param_type.toLowerCase():"",""!=result.second_node&&(result.second_node="");result.param_name!=param_name&&(result.param_name=param_name),result.first_node!=param_name&&(result.first_node=param_name)}else result.is_list="0",result.first_node="",result.second_node=""},$scope.processListCheck=function(result){result._customized&&$rootScope.nextTick(function(){var param_name=void 0;if("1"==result.is_list){param_name=result.param_type?result.param_type.toLowerCase()+"s":"";var second_param_name=result.param_type?result.param_type.toLowerCase():"";result.second_node!=second_param_name&&(result.second_node=second_param_name)}else param_name=result.param_type?result.param_type.toLowerCase():"",""!=result.second_node&&(result.second_node="");result.param_name!=param_name&&(result.param_name=param_name),result.first_node!=param_name&&(result.first_node=param_name)})},$scope.saveAPI=function(){if(!$scope.updaterAPI)return void $scope.alert("没有初始化数据");var frontEndMode=4==$scope.mode,normalMode=1==$scope.mode;if(normalMode){if($scope.updaterAPIForm.$invalid)return void($scope.updaterAPIForm.$error.required&&$scope.updaterAPIForm.$error.required.forEach(function(r){r.$setDirty(!0)}))}else if(frontEndMode&&$scope.updaterFrontEndAPIForm.$invalid)return void($scope.updaterFrontEndAPIForm.$error.required&&$scope.updaterFrontEndAPIForm.$error.required.forEach(function(r){r.$setDirty(!0)}));var api={cat_id:$scope.updaterSelection.panelCat.cat_id,group_id:$scope.updaterSelection.panelCatGroup.group_id,api_id:$scope.updaterAPI.api_id,call_flag:$scope.updaterAPI.call_flag,api_name:$scope.updaterAPI.api_name,api_title:$scope.updaterAPI.api_title,api_title_en:$scope.updaterAPI.api_title_en,api_desc:$scope.updaterAPI.api_desc,api_desc_en:$scope.updaterAPI.api_desc_en,return_example_xml:$scope.updaterAPI.return_example_xml,return_example_json:$scope.updaterAPI.return_example_json,test_url:$scope.updaterAPI.test_url,online_url:$scope.updaterAPI.online_url,timeout:$scope.updaterAPI.timeout,api_rank:$scope.updaterAPI.api_rank,is_noserver:$scope.updaterAPI.is_noserver,business_param:[].concat.apply([],$scope.updaterAPI.busparam.map(function(r){return r.param_name?[r]:[]})),return_result:[].concat.apply([],$scope.updaterAPI.result.map(function(r){return r.param_name?[r]:[]})),business_error:[].concat.apply([],$scope.updaterAPI.buserror.map(function(r){return r.error_code?[r]:[]})),environment_url:$scope.updaterAPI.api_id?void 0:$scope.updaterAPI.environment_url};return api.call_flag&&api.cat_id&&api.api_title&&api.api_title_en&&api.api_desc&&api.api_desc_en&&api.return_example_xml&&api.return_example_json&&api.test_url&&api.online_url&&api.timeout&&api.api_rank&&api.is_noserver&&(!api.environment_url||!api.environment_url.length||[].concat.apply([],api.environment_url.map(function(r){return r.url?[r]:[]})).length)?!api.call_flag||"0"!=api.call_flag||api.return_result&&api.return_result.length?$rootScope.confirm("系统将保存API设置，您确认要保存吗？",function(){if(!$scope.refreshing)return $scope.refreshing=!0,$rootScope.ajax("api_save",api).then(function(data){$scope.refreshing=!1,$scope.resetOrder(),$scope.resetAuditFree(),$scope.exitMode(),$scope.step=0,$scope.nextKeyPressed=!1,$scope.updaterAPI.api_id?$scope.searcher():$scope.research(),normalMode?$scope.updaterAPIForm.$setPristine():frontEndMode&&$scope.updaterFrontEndAPIForm.$setPristine(),$scope.updaterAPI=JSON.parse(JSON.stringify(initialUpdaterAPI))},function(why){$scope.refreshing=!1})}):void $scope.alert("全栈模式必须有返回结果"):void $scope.alert("基本信息不能为空")},$scope.checkBasicError=function(){return 1==$scope.mode?$scope.updaterAPIForm.api_name.$invalid||$scope.updaterAPIForm.timeout.$invalid||$scope.updaterAPIForm.api_title.$invalid||$scope.updaterAPIForm.api_title_en.$invalid||$scope.updaterAPIForm.api_desc.$invalid||$scope.updaterAPIForm.api_desc_en.$invalid||$scope.updaterAPIForm.return_example_xml.$invalid||$scope.updaterAPIForm.return_example_json.$invalid||$scope.updaterAPIForm.test_url.$invalid||$scope.updaterAPIForm.online_url.$invalid:4==$scope.mode&&($scope.updaterFrontEndAPIForm.api_name.$invalid||$scope.updaterFrontEndAPIForm.timeout.$invalid||$scope.updaterFrontEndAPIForm.api_title.$invalid||$scope.updaterFrontEndAPIForm.api_title_en.$invalid||$scope.updaterFrontEndAPIForm.api_desc.$invalid||$scope.updaterFrontEndAPIForm.api_desc_en.$invalid||$scope.updaterFrontEndAPIForm.return_example_xml.$invalid||$scope.updaterFrontEndAPIForm.return_example_json.$invalid||$scope.updaterFrontEndAPIForm.test_url.$invalid||$scope.updaterFrontEndAPIForm.online_url.$invalid)},$scope.checkEnvironmentError=function(){if(1==$scope.mode){var envs=[];return $scope.updaterAPI&&$scope.updaterAPI.environment_url&&$scope.updaterAPI.environment_url.length&&(envs=[].concat.apply([],$scope.updaterAPI.environment_url.map(function(r,i){return $scope.updaterAPIForm["envurl"+i].$invalid?[r]:[]}))),envs.length>0}if(4==$scope.mode){var _envs=[];return $scope.updaterAPI&&$scope.updaterAPI.environment_url&&$scope.updaterAPI.environment_url.length&&(_envs=[].concat.apply([],$scope.updaterAPI.environment_url.map(function(r,i){return $scope.updaterFrontEndAPIForm["envurl"+i].$invalid?[r]:[]}))),_envs.length>0}return!1},$scope.orderSelection={},$scope.orderSelection.panelCat=initCat,$scope.orderSelection.panelCatGroup=initGroup,$scope.chooseOrderCat=function(cat,group){$scope.orderSelection.panelCat=cat?cat:{},$scope.orderSelection.panelCatGroup=group?group:{},$scope.sortList()},$scope.sortList=function(){return $rootScope.ajax("sort_list",{cat_id:$scope.orderSelection.panelCat.cat_id,group_id:$scope.orderSelection.panelCatGroup.group_id},function(data){$scope.originalSortData=JSON.parse(JSON.stringify(data)),$scope.sortData=data})},$scope.sortSave=function(){$scope.sortData&&$scope.sortData.api_list||$scope.alert("没有可选排序项");var apiIDs=$scope.sortData.api_list.map(function(r){return{api_id:r.api_id}});return $rootScope.ajax("sort_save",{api_list:apiIDs},function(data){$scope.searcher().then(function(){$rootScope.nextTick(function(){$scope.exitMode()})})})},$scope.resetOrder=function(){return initAPIQ&&initAPIQ.then(function(data){return $scope.orderSelection.panelCat=initCat,$scope.orderSelection.panelCatGroup=initGroup,$scope.orderSelection.panelCat&&$scope.orderSelection.panelCat.cat_id&&$scope.sortList(),data})},$scope.resetOrder(),$scope.exitOrder=function(){$scope.mode=0,$scope.resetOrder()},$scope.auditFreeSelection={},$scope.auditFreeSelection.panelCat=initCat,$scope.auditFreeSelection.panelCatGroup=initGroup,$scope.noAuditTableData=[];var auditFreeListQ=$rootScope.defer().promise;$scope.noAuditResearch=function(){$scope.noAuditPageIndex=1,$scope.noAuditPageSize=new Number(10)},$scope.auditFreeListAPI=function(){return $rootScope.ajax("noaudit_list",{cat_id:$scope.auditFreeSelection.panelCat.cat_id,group_id:$scope.auditFreeSelection.panelCatGroup.group_id},function(data){return data})},$scope.chooseAuditFreeCat=function(cat,group){return $scope.auditFreeSelection.panelCat=cat?cat:{cat_id:"",cat_name:"全部分类"},0==auditFreeListQ.$$state.status?(auditFreeListQ=$scope.auditFreeListAPI().then(function(data){return data?($scope.noAuditData=data.data_list.map(function(r){return r._checked="1"==r.apply_flag,r}),$scope.noAuditTotal=data.data_list.length,data.data_list):data}),void auditFreeListQ.then($scope.noAuditResearch)):void $scope.auditFreeListAPI().then(function(data){return data&&($scope.noAuditData=data.data_list.map(function(r){return r._checked="1"==r.apply_flag,r}),$scope.noAuditTotal=data.data_list.length,$scope.noAuditResearch()),data})},$scope.resetAuditFree=function(){$scope.noAuditColumns=[{text:"API名称",name:"api_name",tooltip:!0},{text:"API分类",name:"cat_name"},{text:"API描述",name:"api_title"}],$scope.noAuditBatch=!0,$scope.auditFreeSelection.panelCat={cat_id:"",cat_name:"全部分类"},$scope.noAuditPageIndex=1,$scope.chooseAuditFreeCat()},$scope.resetAuditFree(),$scope.exitAuditFree=function(){$scope.mode=0,$scope.resetAuditFree()},$scope.auditSearcher=function(index,size){return auditFreeListQ.then(function(data){if(!data)return!1;var list=[].concat.apply([],$scope.noAuditData.map(function(r,i){return r._checked="1"==r.apply_flag,i>=(index-1)*size&&i<index*size?[r]:[]}));$scope.noAuditTableData=list})},$scope.auditFreeSaveAPI=function(){var apiIDs=[].concat.apply([],$scope.noAuditData.map(function(r){return r._checked?[{api_id:r.api_id}]:[]}));return $rootScope.ajax("noaudit_save",{api_list:apiIDs,cat_id:$scope.auditFreeSelection.panelCat.cat_id},function(data){auditFreeListQ=$scope.auditFreeListAPI().then(function(data){return data?($scope.noAuditData=data.data_list.map(function(r){return r._checked="1"==r.apply_flag,r}),$scope.noAuditTotal=data.data_list.length,data.data_list):data}),$scope.exitMode()})},$scope.cacheInitAPI=function(){return $rootScope.ajax("cache_init",{api_id:$scope.tableData._select.api_id},function(data){return data})},$scope.showCache=function(ev){if(!$scope.tableData._select||!$scope.tableData._select.api_id)return void $rootScope.alert("没有选中一条数据");var getStatus=function(status){return"0"==status?"关闭":"1"==status?"已开启":"2"==status?"申请开启":"3"==status?"拒绝开启":""==status?"无":"未知"};$scope.cacheInitAPI().then(function(data){var CacheController=function(scope,$mdDialog){scope.cache_time=data.cache_time?data.cache_time:"0",scope.cache_status=data.cache_status,scope.cache_status_text=getStatus(data.cache_status),scope.cache_time_online=data.cache_time_online?data.cache_time_online:"0",scope.cache_status_online=data.cache_status_online,scope.cache_status_online_text=getStatus(data.cache_status_online),scope.cancel=function(){$mdDialog.hide()},scope.apply=function(cache_type,cache_status){if(!scope.cacheLoading)return scope.cacheLoading=!0,$rootScope.ajax("cache_apply",{cache_type:cache_type,cache_status:cache_status,api_id:$scope.tableData._select.api_id},function(data){return $scope.cacheInitAPI().then(function(data){return scope.cache_time=data.cache_time?data.cache_time:"0",scope.cache_status=data.cache_status,scope.cache_status_text=getStatus(data.cache_status),scope.cache_time_online=data.cache_time_online?data.cache_time_online:"0",scope.cache_status_online=data.cache_status_online,scope.cache_status_online_text=getStatus(data.cache_status_online),data})})["finally"](function(){scope.cacheLoading=!1})},scope.save=function(){if(!scope.cacheLoading&&!scope.cacheForm.$invalid)return scope.cacheLoading=!0,$rootScope.ajax("cache_save",{
api_id:$scope.tableData._select.api_id,cache_time:scope.cache_time,cache_time_online:scope.cache_time_online},function(data){$mdDialog.hide()})["finally"](function(){scope.cacheLoading=!1})}};$mdDialog.show({controller:CacheController,template:'<md-dialog aria-label="Mango" class="cache-dialog">\n                                <md-dialog-content class="md-dialog-content">\n                                    <div class="md-dialog-content-head">\n                                        <h4>设置缓存</h4>\n                                        <md-progress-circular md-mode="indeterminate" ng-show="cacheLoading" class="md-primary"></md-progress-circular>\n                                    </div>\n                                    <div class="md-dialog-content-body">\n                                        <form name="cacheForm" autocomplete="off">\n                                            <table class="md-datatable">\n                                                <thead>\n                                                    <tr>\n                                                        <th colspan="2">沙箱环境</th>\n                                                        <th colspan="2">生产环境</th>\n                                                    </tr>\n                                                </thead>\n                                                <tbody>\n                                                    <tr>\n                                                        <td>缓存状态</td>\n                                                        <td>\n                                                            <div class="cache-row">\n                                                                <span ng-bind="cache_status_text"></span>\n                                                                <md-button ng-if="(cache_status == \'0\') || (cache_status == \'3\')" ng-click="apply(\'0\',\'2\')" class="md-raised text line" aria-label="data control" ng-disabled="cacheLoading" ><span>启动</span></md-button>\n                                                                <md-button ng-if="cache_status == \'1\'" ng-click="apply(\'0\',\'0\')" class="md-raised text line" aria-label="data control" ng-disabled="cacheLoading" ><span>关闭</span></md-button>\n                                                            </div>\n                                                        </td>\n                                                        <td>缓存状态</td>\n                                                        <td>\n                                                            <div class="cache-row">\n                                                                <span ng-bind="cache_status_online_text"></span>\n                                                                <md-button ng-if="(cache_status_online == \'0\') || (cache_status_online == \'3\')" ng-click="apply(\'1\',\'2\')" class="md-raised text line" aria-label="data control" ng-disabled="cacheLoading" ><span>启动</span></md-button>\n                                                                <md-button ng-if="cache_status_online == \'1\'" ng-click="apply(\'1\',\'0\')" class="md-raised text line" aria-label="data control" ng-disabled="cacheLoading" ><span>关闭</span></md-button>\n                                                            </div>\n                                                        </td>\n                                                    </tr>\n                                                    <tr>\n                                                        <td>缓存时间</td>\n                                                        <td><div class="cache-row"><input type="text" id="sandbox_cache" name="sandbox_cache" ng-model="cache_time" pattern="^([1-9]\\d{0,5}|0)$" ng-disabled="!cache_status" required/><label for="sandbox_cache">分钟</label></div></td>\n                                                        <td>缓存时间</td>\n                                                        <td><div class="cache-row"><input type="text" id="production_cache" name="production_cache" ng-model="cache_time_online" pattern="^([1-9]\\d{0,5}|0)$" ng-disabled="!cache_status_online" required/><label for="production_cache">分钟</label></div></td>\n                                                    </tr>\n                                                </tbody>\n                                            </table>\n                                        </form>\n                                    </div>\n                                </md-dialog-content>\n                                <md-dialog-actions layout="row">\n                                  <md-button ng-click="cancel()">\n                                    取消\n                                  </md-button>\n                                  <md-button ng-click="save()" ng-disabled="cacheLoading">\n                                    保存\n                                  </md-button>\n                                </md-dialog-actions>\n                            </md-dialog>',targetEvent:ev,clickOutsideToClose:!0}).then(function(answer){$scope.status='You said the information was "'+answer+'".'},function(){$scope.status="You cancelled the dialog."})})};var modeInfo=[{title:"API列表",cancelFunction:$scope.reset,desc:"您可以使用API列表模块管理供应商API，更改API状态，为API添加缓存功能等"},{title:"API详情",cancelFunction:$scope.cancelStep,desc:"您可以使用API详情模块添加和修改供应商API"},{title:"API排序",cancelFunction:$scope.exitOrder,desc:"您可以使用API排序模块对API进行排序"},{title:"API免审核",cancelFunction:$scope.exitAuditFree,desc:"您可以使用API免审核模块管理免审核型API"},{title:"API详情(前端)",cancelFunction:$scope.cancelStep,desc:"您可以使用API详情模块添加和修改供应商API"}];$scope.getModeInfo=function(){return"number"==typeof $scope.mode?modeInfo[$scope.mode]:modeInfo[0]},$scope.appendRow=function(row,list){list.push(row?row:{})},$scope.removeRow=function(row,list){list.splice(list.indexOf(row),1)},window.test=$scope,$scope.injectorLoaded=!0}]});