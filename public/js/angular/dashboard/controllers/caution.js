"use strict";function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}define(["../../services"],function(cta){return["$rootScope","$scope","$q","$location","$http","$timeout","$mdDialog","MiscTool",function($rootScope,$scope,$q,$location,$http,$timeout,$mdDialog,MiscTool){$rootScope.tab="caution",$scope.mode=0,$scope.selectMode=function(mode){$scope.loading||$scope.refreshing||(0==mode?$scope.mode=mode:1==mode?sysErrorQ.then(function(){$scope.mode=mode}):2==mode&&urlErrorQ.then(function(){$scope.mode=mode}))},$scope.loading=!0,$scope.apiKeyword="",$scope.apiInterval="",$scope.apiCountdown="",$scope.sysKeyword="",$scope.sysInterval="",$scope.sysCountdown="",$scope.urlKeyword="",$scope.urlInterval="",$scope.urlCountdown="",$scope.urlTimeout="";var apiQ=$rootScope.ajax("api_list").then(function(data){return $scope.api_list=data.data_list,$scope.selectAPI($scope.api_list[0])})["finally"](function(){$scope.loading=!1}),getMailQ=function(){return $rootScope.ajax("mail_list").then(function(data){return $scope.mail_error_list=data.data_list,$scope.mailGetter=function(){return $scope.mail_error_list.map(function(r){return r.user_mail}).join(";")},data})},mailQ=getMailQ(),getMobileQ=function(){return $rootScope.ajax("mobile_list").then(function(data){return $scope.mobile_error_list=data.data_list,$scope.mobileGetter=function(){return $scope.mobile_error_list.map(function(r){return r.user_mobile}).join(";")},data})},mobileQ=getMobileQ(),getSysError=function(){return $rootScope.ajax("sys_error_list").then(function(data){$scope.sys_error=data})},sysErrorQ=getSysError(),getUrlError=function(){return $rootScope.ajax("url_list").then(function(data){$scope.url_error=data})},urlErrorQ=getUrlError();$scope.reset=function(){$scope.loading||$scope.refreshing||(0==$scope.mode?apiQ.then(function(){return $scope.api_list&&$scope.api_list[0]?$scope.selectAPI($scope.api_list[0]):void 0}):1==$scope.mode?($scope.refreshing=!0,sysErrorQ=getSysError()["finally"](function(){$scope.refreshing=!1})):2==$scope.mode&&($scope.refreshing=!0,urlErrorQ=getUrlError()["finally"](function(){$scope.refreshing=!1})))},$scope.api_error_all=[],$scope.selectAPI=function(api){return $scope.api_list?($scope.api_list._selected=api,$scope.refreshing=!0,$rootScope.ajax("error_list",{api_id:api.api_id}).then(function(data){$scope.api_error=data,$scope.api_error_all=(data.error_list||[]).concat([data.error_main]),$scope.getAPIErrorAll=function(){return(data.error_list||[]).concat([data.error_main])}})["finally"](function(){$scope.refreshing=!1})):$q.reject()},$scope.apiErrorSave=function(){return apiQ.then(function(){if(!$scope.refreshing){if($scope.alarmForm.$invalid)return $scope.alarmForm.$error.required&&$scope.alarmForm.$error.required.forEach(function(r){r.$setDirty(!0)}),$scope.alarmForm.$error.pattern&&$scope.alarmForm.$error.pattern.forEach(function(r){r.$setDirty(!0)}),$scope.alarmForm.$error.maxlength&&$scope.alarmForm.$error.maxlength.forEach(function(r){r.$setDirty(!0)}),void($scope.alarmForm.$error.email&&$scope.alarmForm.$error.email.forEach(function(r){r.$setDirty(!0)}));if($scope.api_list){$scope.refreshing=!0;for(var error_list=$scope.api_error.error_list.concat([$scope.api_error.error_main]),i=0;i<error_list.length;i++)!error_list[i].main_flag&&(error_list[i].main_flag="0");return $rootScope.ajax("error_save",{api_id:$scope.api_list._selected.api_id,error_list:error_list}).then(function(data){return $scope.selectAPI($scope.api_list._selected)})["finally"](function(){$scope.refreshing=!1})}return $q.reject()}})},$scope.apiLocate=function(){return apiQ.then(function(){if(!$scope.api_list)return $q.reject();var list=[].concat.apply([],$scope.api_list.map(function(r,v){return r.api_name.indexOf($scope.apiKeyword)!=-1||r.api_title.indexOf($scope.apiKeyword)!=-1?[v]:[]}));$scope.apiTopIndex=list[0]})},$scope.apiLocateNext=function(){return apiQ.then(function(){if(!$scope.api_list)return $q.reject();for(var list=[].concat.apply([],$scope.api_list.map(function(r,v){return r.api_name.indexOf($scope.apiKeyword)!=-1||r.api_title.indexOf($scope.apiKeyword)!=-1?[v]:[]})),i=0;i<list.length;i++){if(list[i]>$scope.apiTopIndex){$scope.apiTopIndex=list[i];break}i==list.length-1&&($scope.apiTopIndex=list[0])}})},$scope.sysLocate=function(){return sysErrorQ.then(function(){if(!$scope.sys_error||!$scope.sys_error.api_list)return $q.reject();var list=[].concat.apply([],$scope.sys_error.api_list.map(function(r,v){return r.api_name.indexOf($scope.sysKeyword)!=-1||r.api_title.indexOf($scope.sysKeyword)!=-1?[v]:[]}));$scope.sysTopIndex=list[0]})},$scope.sysLocateNext=function(){return sysErrorQ.then(function(){if(!$scope.sys_error||!$scope.sys_error.api_list)return $q.reject();for(var list=[].concat.apply([],$scope.sys_error.api_list.map(function(r,v){return r.api_name.indexOf($scope.sysKeyword)!=-1||r.api_title.indexOf($scope.sysKeyword)!=-1?[v]:[]})),i=0;i<list.length;i++){if(list[i]>$scope.sysTopIndex){$scope.sysTopIndex=list[i];break}i==list.length-1&&($scope.sysTopIndex=list[0])}})},$scope.sysErrorSave=function(){return sysErrorQ.then(function(){if(!$scope.refreshing){var list=[].concat.apply([],$scope.sys_error.api_list.map(function(r,i){return"1"==r.check_flag?[{api_id:r.api_id}]:[]}));return $scope.systemForm.$invalid?($scope.systemForm.$error.required&&$scope.systemForm.$error.required.forEach(function(r){r.$setDirty(!0)}),$scope.systemForm.$error.pattern&&$scope.systemForm.$error.pattern.forEach(function(r){r.$setDirty(!0)}),$scope.systemForm.$error.maxlength&&$scope.systemForm.$error.maxlength.forEach(function(r){r.$setDirty(!0)}),void($scope.systemForm.$error.email&&$scope.systemForm.$error.email.forEach(function(r){r.$setDirty(!0)}))):list.length?$scope.sys_error&&$scope.sys_error.api_list&&$scope.sys_error.api_list.length&&$scope.sys_error.error_list&&$scope.sys_error.error_list.length?($scope.refreshing=!0,$rootScope.ajax("sys_error_save",{api_list:list,error_list:$scope.sys_error.error_list}).then(function(data){return sysErrorQ=getSysError()})["finally"](function(){$scope.refreshing=!1})):$q.reject():void $rootScope.alert("请选择至少一条API")}})},$scope.urlLocate=function(){return urlErrorQ.then(function(){if(!$scope.url_error||!$scope.url_error.data_list)return $q.reject();var list=[].concat.apply([],$scope.url_error.data_list.map(function(r,v){return r.caution_title.indexOf($scope.urlKeyword)!=-1||r.caution_url.indexOf($scope.urlKeyword)!=-1?[v]:[]}));angular.element("#urlScroller")[0].scrollTop=40*list[0],list[0]?$scope.urlTopIndex=list[0]:$scope.urlTopIndex=void 0})},$scope.urlLocateNext=function(){return urlErrorQ.then(function(){if(!$scope.url_error||!$scope.url_error.data_list)return $q.reject();for(var list=[].concat.apply([],$scope.url_error.data_list.map(function(r,v){return r.caution_title.indexOf($scope.urlKeyword)!=-1||r.caution_url.indexOf($scope.urlKeyword)!=-1?[v]:[]})),i=0;i<list.length;i++){if(list[i]>$scope.urlTopIndex){$scope.urlTopIndex=list[i];break}i==list.length-1&&($scope.urlTopIndex=list[0])}angular.element("#urlScroller")[0].scrollTop=40*$scope.urlTopIndex})},$scope.urlErrorSave=function(){return urlErrorQ.then(function(){if(!$scope.refreshing){if($scope.urlForm.$invalid)return $scope.urlForm.$error.required&&$scope.urlForm.$error.required.forEach(function(r){r.$setDirty(!0)}),$scope.urlForm.$error.pattern&&$scope.urlForm.$error.pattern.forEach(function(r){r.$setDirty(!0)}),$scope.urlForm.$error.maxlength&&$scope.urlForm.$error.maxlength.forEach(function(r){r.$setDirty(!0)}),void($scope.urlForm.$error.email&&$scope.urlForm.$error.email.forEach(function(r){r.$setDirty(!0)}));for(var i=0;i<$scope.url_error.data_list.length;i++){var item=$scope.url_error.data_list[i];"1"!=item.mail_flag&&"1"!=item.sms_flag?item.caution_switch="0":item.caution_switch="1"}return $scope.url_error&&$scope.url_error.data_list?($scope.refreshing=!0,$http.post("/agent",{module:"application",partial:$rootScope.tab,api:"url_save",param:{url_list:$scope.url_error.data_list}}).then(function(body){return"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?(urlErrorQ=getUrlError(),$scope.urlKeyword="",urlErrorQ):($rootScope.alert(body.data.msg),$scope.urlKeyword=body.data.sub_msg,$scope.urlLocate(),void 0)},function(why){return $rootScope.alert(why),$q.reject(why)})["finally"](function(){$scope.refreshing=!1})):$q.reject()}})},$scope.isSMSRequired=function(row){return!!row&&!("1"!=row.sms_flag||$scope.mobile_error_list&&$scope.mobile_error_list.length)},$scope.isMailRequired=function(row){return!!row&&!("1"!=row.mail_flag||$scope.mail_error_list&&$scope.mail_error_list.length)};var MailController=function(scope,mail_list){scope.mail_list=JSON.parse(JSON.stringify(mail_list)),scope.append=function(list){return $scope.append(list,"#"+scope.uniqueID)},scope.splice=$scope.splice,scope.uniqueID=String((new Date).getTime()),scope.title="全局邮件报警设置";var regardless=void 0;scope.saveMail=function(){if(!scope.refreshing){if(scope.mailForm.$invalid)return scope.mailForm.$error.required&&scope.mailForm.$error.required.forEach(function(r){r.$setDirty(!0)}),scope.mailForm.$error.pattern&&scope.mailForm.$error.pattern.forEach(function(r){r.$setDirty(!0)}),void(scope.mailForm.$error.email&&scope.mailForm.$error.email.forEach(function(r){r.$setDirty(!0)}));if(scope.mail_list&&!scope.mail_list.length)return void(scope.error="清空全局报警邮箱会引起部分自定义邮箱报警设置无法使用");var mail_error_list_length=scope.mail_list&&scope.mail_list.length||0,uniqueList=[].concat(_toConsumableArray(new Set((scope.mail_list||[]).map(function(r){return r.user_mail}))));return!regardless&&uniqueList.length<mail_error_list_length?(scope.error="系统将对重复的数据做合并处理",regardless=!0,$q.reject()):(scope.refreshing=!0,$http.post("/agent",{module:"application",partial:$rootScope.tab,api:"mail_save",param:{mail_list:scope.mail_list}}).then(function(body){return"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?mailQ=getMailQ().then(function(data){return scope.close(),data}):(scope.error=body.data.msg,$q.reject(body.data.msg))},function(why){return scope.error=why,$q.reject(why)})["finally"](function(){scope.refreshing=!1}))}},scope.close=function(){$mdDialog.hide()}},RowMailController=function(scope,row){scope.mail_list=row&&row.caution_mail?row.caution_mail.split(";").map(function(r){return{user_mail:r}}):[],scope.append=function(list){return $scope.append(list,"#"+scope.uniqueID)},scope.splice=$scope.splice,scope.uniqueID=String((new Date).getTime()),scope.title="自定义邮件报警设置";var regardless=void 0;scope.saveMail=function(){if(scope.mailForm.$invalid)return scope.mailForm.$error.required&&scope.mailForm.$error.required.forEach(function(r){r.$setDirty(!0)}),scope.mailForm.$error.pattern&&scope.mailForm.$error.pattern.forEach(function(r){r.$setDirty(!0)}),void(scope.mailForm.$error.email&&scope.mailForm.$error.email.forEach(function(r){r.$setDirty(!0)}));var mail_error_list_length=scope.mail_list&&scope.mail_list.length||0,uniqueList=[].concat(_toConsumableArray(new Set((scope.mail_list||[]).map(function(r){return r.user_mail}))));return!regardless&&uniqueList.length<mail_error_list_length?(scope.error="系统将对重复的数据做合并处理",void(regardless=!0)):(row.caution_mail=[].concat(_toConsumableArray(new Set(scope.mail_list.map(function(r){return r.user_mail})))).join(";"),void scope.close())},scope.close=function(){$mdDialog.hide()}},mailerTemplate='\n                                <md-dialog aria-label="邮箱报警设置" class="quick-edit" aria-describedby="quick edit">\n                                    <md-toolbar>\n                                        <div class="md-toolbar-tools">\n                                            <md-icon md-svg-icon="communication:ic_mail_outline_24px"></md-icon>\n                                            <h3><span ng-bind=\'title\'></span></h3>\n                                            <md-button class="md-icon-button md-primary md-hue-1" aria-label="Settings" ng-click="close()">\n                                                <md-icon md-svg-icon="content:ic_clear_24px"></md-icon>\n                                            </md-button>\n                                        </div>\n                                    </md-toolbar>\n                                \n                                    <md-dialog-content>\n                                        <div class="md-dialog-content" >\n                                            <form name="mailForm" class="table-wrapper" autocomplete="off">\n                                                <table cellspacing="0" class="md-datatable fixed">\n                                                    <thead>\n                                                    <tr>\n                                                        <th>\n                                                            <md-icon md-svg-icon="content:ic_add_24px" class="expander" ng-click="append(mail_list)"></md-icon>\n                                                        </th>\n                                                        <th>\n                                                            <span>邮箱名称</span>\n                                                        </th>\n                                                    </tr>\n                                                    </thead>\n                                                </table>\n                                                <div class="scroller" id="{{uniqueID}}">\n                                                    <table cellspacing="0" class="md-datatable">\n                                                        <tbody>\n                                                        <tr ng-repeat="mail in mail_list">\n                                                            <td>\n                                                                <md-icon md-svg-icon="content:ic_remove_24px" class="collapser" ng-click="splice(mail_list,mail)"></md-icon>\n                                                            </td>\n                                                            <td class="blend-wrapper">\n                                                                <input type="text" class="blend" name="user_mail{{$index}}" placeholder="请输入报警邮箱" ng-model="mail.user_mail" required pattern="^((?=[\\w\\.])[^;])+?@((?=[\\w\\.])[^;])+$"/>\n                                                            </td>\n                                                        </tr>\n                                                        </tbody>                            \n                                                    </table>\n                                                </div>\n                                                <div class="app-loading" ng-if="refreshing">\n                                                    <md-progress-circular md-mode="indeterminate"></md-progress-circular>\n                                                </div>\n                                            </form>\n                                        </div>\n                                    </md-dialog-content>\n                                    \n                                    <md-dialog-actions layout="row">\n                                        <div class="message" ng-if="error">\n                                            <span ng-bind="error"></span>\n                                        </div>\n                                      <md-button ng-click="saveMail()">保存</md-button>\n                                    </md-dialog-actions>\n                                </md-dialog>\n                            ';$scope.mailer=function(ev){mailQ.then(function(data){return $mdDialog.show({controller:MailController,template:mailerTemplate,parent:angular.element("body>section>md-content"),targetEvent:ev,clickOutsideToClose:!0,locals:{mail_list:data.data_list}}),data})},$scope.rowMailer=function(row,ev){$mdDialog.show({controller:RowMailController,template:mailerTemplate,parent:angular.element("body>section>md-content"),targetEvent:ev,clickOutsideToClose:!0,locals:{row:row}})};var MobileController=function(scope,mobile_list){scope.mobile_list=JSON.parse(JSON.stringify(mobile_list)),scope.append=function(list){return $scope.append(list,"#"+scope.uniqueID)},scope.splice=$scope.splice,scope.title="全局短信报警设置",scope.uniqueID=String((new Date).getTime());var regardless=void 0;scope.saveMobile=function(){if(!scope.refreshing){if(scope.mobileForm.$invalid)return scope.mobileForm.$error.required&&scope.mobileForm.$error.required.forEach(function(r){r.$setDirty(!0)}),void(scope.mobileForm.$error.pattern&&scope.mobileForm.$error.pattern.forEach(function(r){r.$setDirty(!0)}));if(scope.mobile_list&&!scope.mobile_list.length)return void(scope.error="清空全局报警手机会引起部分自定义短信报警设置无法使用");var mobile_error_list_length=scope.mobile_list&&scope.mobile_list.length||0,uniqueList=[].concat(_toConsumableArray(new Set((scope.mobile_list||[]).map(function(r){return r.user_mobile}))));return!regardless&&uniqueList.length<mobile_error_list_length?(scope.error="系统将对重复的数据做合并处理",regardless=!0,$q.reject()):(scope.refreshing=!0,$http.post("/agent",{module:"application",partial:$rootScope.tab,api:"mobile_save",param:{mobile_list:scope.mobile_list}}).then(function(body){return"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?mobileQ=getMobileQ().then(function(data){return scope.close(),data}):(scope.error=body.data.msg,$q.reject(body.data.msg))},function(why){return scope.error=why,$q.reject(why)})["finally"](function(){scope.refreshing=!1}))}},scope.close=function(){$mdDialog.hide()}},RowMobileController=function(scope,row){scope.mobile_list=row&&row.caution_mobile?row.caution_mobile.split(";").map(function(r){return{user_mobile:r}}):[],scope.append=function(list){return $scope.append(list,"#"+scope.uniqueID)},scope.splice=$scope.splice,scope.title="自定义短信报警设置",scope.uniqueID=String((new Date).getTime());var regardless=void 0;scope.saveMobile=function(){if(scope.mobileForm.$invalid)return scope.mobileForm.$error.required&&scope.mobileForm.$error.required.forEach(function(r){r.$setDirty(!0)}),void(scope.mobileForm.$error.pattern&&scope.mobileForm.$error.pattern.forEach(function(r){r.$setDirty(!0)}));var mobile_error_list_length=scope.mobile_list&&scope.mobile_list.length||0,uniqueList=[].concat(_toConsumableArray(new Set((scope.mobile_list||[]).map(function(r){return r.user_mobile}))));return!regardless&&uniqueList.length<mobile_error_list_length?(scope.error="系统将对重复的数据做合并处理",void(regardless=!0)):(row.caution_mobile=[].concat(_toConsumableArray(new Set(scope.mobile_list.map(function(r){return r.user_mobile})))).join(";"),void scope.close())},scope.close=function(){$mdDialog.hide()}},mobilerTemplate='\n                                <md-dialog aria-label="用户提醒" class="quick-edit" aria-describedby="quick edit">\n                                    <md-toolbar>\n                                        <div class="md-toolbar-tools">\n                                            <md-icon class="" md-svg-icon="hardware:ic_phone_iphone_24px"></md-icon>\n                                            <h3><span ng-bind=\'title\'></span></h3>\n                                            <md-button class="md-icon-button md-primary md-hue-1" aria-label="Settings" ng-click="close()">\n                                                <md-icon md-svg-icon="content:ic_clear_24px"></md-icon>\n                                            </md-button>\n                                        </div>\n                                    </md-toolbar>\n                                \n                                    <md-dialog-content>\n                                        <div class="md-dialog-content" >\n                                            <form name="mobileForm" class="table-wrapper" autocomplete="off">\n                                                <table cellspacing="0" class="md-datatable fixed">\n                                                    <thead>\n                                                    <tr>\n                                                        <th>\n                                                            <md-icon md-svg-icon="content:ic_add_24px" class="expander" ng-click="append(mobile_list)"></md-icon>\n                                                        </th>\n                                                        <th>\n                                                            <span>手机号码</span>\n                                                        </th>\n                                                    </tr>\n                                                    </thead>\n                                                </table>\n                                                <div class="scroller" id="{{uniqueID}}">\n                                                    <table cellspacing="0" class="md-datatable">\n                                                        <tbody>\n                                                        <tr ng-repeat="mobile in mobile_list">\n                                                            <td>\n                                                                <md-icon md-svg-icon="content:ic_remove_24px" class="collapser" ng-click="splice(mobile_list,mobile)"></md-icon>\n                                                            </td>\n                                                            <td class="blend-wrapper">\n                                                                <input type="text" class="blend" name="user_mobile{{$index}}" placeholder="请输入手机号码" ng-model="mobile.user_mobile" required pattern="1\\d{10}"/>\n                                                            </td>\n                                                        </tr>\n                                                        </tbody>                            \n                                                    </table>\n                                                </div>\n                                                <div class="app-loading" ng-if="refreshing">\n                                                    <md-progress-circular md-mode="indeterminate"></md-progress-circular>\n                                                </div>\n                                            </form>\n                                        </div>\n                                    </md-dialog-content>\n                                    \n                                    <md-dialog-actions layout="row">\n                                        <div class="message" ng-if="error">\n                                            <span ng-bind="error"></span>\n                                        </div>\n                                      <md-button ng-click="saveMobile()">保存</md-button>\n                                    </md-dialog-actions>\n                                </md-dialog>\n                            ';$scope.mobiler=function(ev){mobileQ.then(function(data){return $mdDialog.show({controller:MobileController,template:mobilerTemplate,targetEvent:ev,parent:angular.element("body>section>md-content"),clickOutsideToClose:!0,locals:{mobile_list:data.data_list}}),data})},$scope.rowMobiler=function(row,ev){$mdDialog.show({controller:RowMobileController,template:mobilerTemplate,targetEvent:ev,parent:angular.element("body>section>md-content"),clickOutsideToClose:!0,locals:{row:row}})},$scope.toggleAll=function(list,props){var allChecked=$scope.allChecked(list,props);if(list&&list.length)if(allChecked)for(var i=0;i<list.length;i++)list[i][props]="0";else for(var i=0;i<list.length;i++)list[i][props]="1"},$scope.allChecked=function(list,props){return list&&list.length?![].concat.apply([],list.map(function(r,i){return"1"!=r[props]?[r]:[]})).length:0},$scope.append=MiscTool.append,$scope.splice=MiscTool.splice,$scope.unifyList=function(list,props,value){if(void 0!==value)for(var i=0;i<list.length;i++)list[i][props]=value||""},$scope.injectorLoaded=!0,window.test=$scope}]});