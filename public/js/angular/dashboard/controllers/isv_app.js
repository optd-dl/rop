"use strict";define(["../../services"],function(cta){return["$rootScope","$scope","$q","$http","$mdDialog",function($rootScope,$scope,$q,$http,$mdDialog){$rootScope.tab="isv_app";var getUserList=function(){return $rootScope.ajax("list_init").then(function(data){$scope.user_list=data.data_list})},userListQ=getUserList();$scope.columns=[{text:"开发者名称",name:"user_name",style:{"text-align":"left"}},{text:"应用名称",name:"app_name",selector:function(row){$scope.viewApp(row)},style:{"text-align":"left"}},{text:"APPKey",name:"appkey",style:{"text-align":"left"}},{text:"添加时间",name:"create_time",style:{"text-align":"center",width:"160px"}}],$scope.chooseUser=function(user){return userListQ.then(function(){$scope.userChoosen=user,$scope.research()})},$scope.searcher=function(index,size){if(!$scope.refreshing)return $scope.refreshing=!0,$rootScope.ajax("list_get",{pageindex:index?index:$scope.pageIndex,pagesize:size?size:$scope.pageSize,app_key:$scope.keyword,search_status:$scope.search_status,isv_user_id:$scope.userChoosen?$scope.userChoosen.user_id:""},function(data){"boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success?($scope.tableData=data.data_list,$scope.total=data.list_count):($rootScope.alert(data.msg),$scope.total=0)},function(){$scope.total=0})["finally"](function(){$scope.refreshing=!1})},$scope.toggleTODO=function(){"0"==$scope.search_status?$scope.search_status="1":$scope.search_status="0",$scope.research()},$scope.viewApp=function(app){if(!$scope.refreshing)return $scope.refreshing=!0,$rootScope.ajax("api_init",{app_id:app?app.app_id:""}).then(function(data){if($scope.appSelected=angular.extend({},data,app),"1"==$scope.search_status){var firstItem=[].concat.apply([],$scope.appSelected.status_list.map(function(r){return"0"==r.status_id?[r]:[]}))[0];$scope.appSelected.statusChoosen=firstItem}$scope.appSelected.sorter={name:"",sort:"1"},$scope.refreshing=!1,$scope.apiReset()},function(){$scope.refreshing=!1})},$scope.research=function(){$scope.pageIndex=1,$scope.pageSize=new Number(10)},$scope.reset=function(){$scope.multiple=!1,$scope.appSelected=void 0,$scope.search_status="0",$scope.userChoosen=void 0,$scope.pageIndex=1,$scope.pageSize=new Number(10),$scope.tableData=[],$scope.keyword=""},$scope.reset(),$scope.chooseCat=function(cat){$scope.refreshing||($scope.appSelected.catChoosen=cat,$scope.apiResearch())},$scope.chooseStatus=function(status){$scope.refreshing||($scope.appSelected.statusChoosen=status,$scope.apiResearch())},$scope.apiColumns=[{text:"API名称",name:"api_name",tooltip:!0,sort:"1",linker:{create:function(row){return Constant.protocol+"://"+Constant.host+":"+Constant.port+"/api/ApiPreview-"+row.api_id+".html"},target:"_blank"}},{text:"状态",name:"status_name",style:{"text-align":"center",width:"96px"}},{text:"描述",name:"api_title",style:{"text-align":"left"}}],$scope.apiReset=function(){$scope.appSelected&&($scope.apiPageIndex=1,$scope.apiPageSize=new Number(10),$scope.apiTableData=[],$scope.apiMultiple=!0)},$scope.canAPIAudit=function(){var checkedList=[].concat.apply([],$scope.apiTableData.map(function(r){return r._checked&&"0"==r.status_id?[r]:[]}));return checkedList.length&&checkedList.length==[].concat.apply([],$scope.apiTableData.map(function(r){return r._checked?[r]:[]})).length},$scope.canAPICancel=function(){var checkedList=[].concat.apply([],$scope.apiTableData.map(function(r){return r._checked&&"1"==r.status_id?[r]:[]}));return checkedList[0]&&1==[].concat.apply([],$scope.apiTableData.map(function(r){return r._checked?[r]:[]})).length},$scope.canAPIDelete=function(){var checkedList=[].concat.apply([],$scope.apiTableData.map(function(r){return r._checked&&"0"==r.status_id?[r]:[]}));return checkedList[0]&&1==[].concat.apply([],$scope.apiTableData.map(function(r){return r._checked?[r]:[]})).length},$scope.auditAPI=function(ev){$scope.refreshing||$rootScope.confirm("确定要审核选中的API吗？",function(){return $scope.refreshing=!0,$http.post("/agent",{module:"application",partial:$rootScope.tab,api:"api_audit",param:{app_id:$scope.appSelected?$scope.appSelected.app_id:"",api_list:[].concat.apply([],$scope.apiTableData.map(function(r){return r._checked?[{api_id:r.api_id}]:[]}))}}).then(function(body){"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?($scope.refreshing=!1,$scope.apiSearcher()):($scope.refreshing=!1,body.data.sub_msg&&showUAT(ev,body.data.sub_msg.uat_list))},function(why){$scope.refreshing=!1,$rootScope.alert(why)})})},$scope.cancelAPI=function(){$scope.refreshing||$rootScope.confirm("确定要解除审核该API吗？",function(){return $scope.refreshing=!0,$rootScope.ajax("api_cancel",{app_id:$scope.appSelected?$scope.appSelected.app_id:"",api_id:[].concat.apply([],$scope.apiTableData.map(function(r){return r._checked?[r.api_id]:[]}))[0]}).then(function(){$scope.refreshing=!1,$scope.apiSearcher()},function(){$scope.refreshing=!1})})},$scope.deleteAPI=function(){$scope.refreshing||$rootScope.confirm("确定要删除选中的API吗？",function(){return $scope.refreshing=!0,$rootScope.ajax("api_delete",{app_id:$scope.appSelected?$scope.appSelected.app_id:"",api_id:[].concat.apply([],$scope.apiTableData.map(function(r){return r._checked?[r.api_id]:[]}))[0]}).then($scope.apiResearch)["finally"](function(){$scope.refreshing=!1})})},$scope.apiSearcher=function(index,size){if(!$scope.refreshing)return $scope.refreshing=!0,$rootScope.ajax("api_get",{pageindex:index?index:$scope.apiPageIndex,pagesize:size?size:$scope.apiPageSize,app_id:$scope.appSelected?$scope.appSelected.app_id:"",cat_id:$scope.appSelected.catChoosen?$scope.appSelected.catChoosen.cat_id:"",status:$scope.appSelected.statusChoosen?$scope.appSelected.statusChoosen.status_id:"",sort_name:$scope.appSelected.sorter.name,sort_flag:$scope.appSelected.sorter.sort},function(data){"boolean"==typeof data.is_success&&data.is_success||"string"==typeof data.is_success&&"true"==data.is_success?($scope.apiTableData=data.data_list,$scope.apiTotal=data.list_count):($rootScope.alert(data.msg),$scope.apiTotal=0)},function(){$scope.apiTotal=0})["finally"](function(){$scope.refreshing=!1})},$scope.apiResearch=function(){$scope.apiPageIndex=1,$scope.apiPageSize=new Number(10)},$scope.exit=function(){$scope.appSelected=void 0};var UATController=function(scope,uat_list){scope.uat_list=uat_list,scope.columns=[{text:"环境名称",name:"ename",style:{"text-align":"center",width:"320px"}}],scope.send=function(){if(!scope.refreshing)return scope.uat_list._select&&scope.uat_list._select.eid?(scope.refreshing=!0,$http.post("/agent",{module:"application",partial:$rootScope.tab,api:"api_audit",param:{app_id:$scope.appSelected?$scope.appSelected.app_id:"",api_list:[].concat.apply([],$scope.apiTableData.map(function(r){return r._checked?[{api_id:r.api_id}]:[]})),eid:scope.uat_list._select.eid}}).then(function(body){return"boolean"==typeof body.data.is_success&&body.data.is_success||"string"==typeof body.data.is_success&&"true"==body.data.is_success?scope.close():(scope.error=body.data.msg,$q.reject(body.data.msg))},function(why){return scope.error=why,$q.reject(why)}).then(function(){$scope.apiSearcher()})["finally"](function(){scope.refreshing=!1})):void(scope.error="请选择环境")},scope.close=function(){return $mdDialog.hide()}},showUAT=function(ev,uat_list){return $mdDialog.show({controller:UATController,template:'\n                                <md-dialog aria-label="API审核" class="reminder" aria-describedby="API审核">\n                                    <md-toolbar>\n                                        <div class="md-toolbar-tools">\n                                            <h3><span>API审核</span></h3>\n                                            <md-icon class="" md-svg-icon="action:ic_info_24px">\n                                                <md-tooltip md-direction="down">初次审核API时，应指定API的使用环境</md-tooltip>\n                                            </md-icon>\n                                            <md-button class="md-icon-button md-primary md-hue-1" aria-label="Settings" ng-click="close()">\n                                                <md-icon md-svg-icon="content:ic_clear_24px"></md-icon>\n                                            </md-button>\n                                        </div>\n                                    </md-toolbar>\n                                \n                                    <md-dialog-content>\n                                        <div class="md-dialog-content" >\n                                            <div class="table-wrapper">\n                                                <rop-fixed-table cols="columns" data="uat_list"/>\n                                                 <div class="app-loading" ng-if="refreshing">\n                                                    <md-progress-circular md-mode="indeterminate"></md-progress-circular>\n                                                </div>\n                                            </div>\n                                        </div>\n                                    </md-dialog-content>\n                                    \n                                    <md-dialog-actions layout="row">\n                                        <div class="message" ng-if="error">\n                                            <span ng-bind="error"></span>\n                                        </div>\n                                      <md-button ng-click="send()">确定</md-button>\n                                    </md-dialog-actions>\n                                </md-dialog>\n                            ',targetEvent:ev,clickOutsideToClose:!1,parent:angular.element(document.querySelector("body>section>md-content")),locals:{uat_list:uat_list}})};$scope.injectorLoaded=!0,window.test=$scope,window.test1=showUAT}]});